<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management | WALAKA</title>
  <link rel="stylesheet" href="./styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="css/hints.css">
    
  <!-- Hints System -->
  <script src="js/hints/walaka-hints.js"></script>
  <script src="js/hints/page-hints.js"></script>
  
  
  
  <style>
:root {
  --primary-color: #007ec7; /* Corporate blue */
  --primary-dark: #005fa3;
  --primary-light: #e6f4fb;
  --secondary-color: #4f46e5;
  --secondary-light: #818cf8;
  --accent-color: #3b82f6;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-light: #94a3b8;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --danger-light: #fee2e2;
  --background-color: #f8fafc;
  --card-background: #ffffff;
  --border-color: #e2e8f0;
  --sidebar-width: 250px;
  --sidebar-collapsed-width: 80px;
  --topbar-height: 60px;
  --card-radius: 16px;
  --input-radius: 8px;
  --transition-speed: 0.3s;
  --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* ===== RESET & BASE STYLES ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background-color: var(--background-color);
  color: #333;
  min-height: 100vh;
  overflow-x: hidden;
}

a {
  text-decoration: none;
  color: inherit;
}

button {
  cursor: pointer;
  font-family: inherit;
}

ul {
  list-style: none;
}

/* ===== LAYOUT ===== */
.dashboard-container {
  display: flex;
  min-height: 100vh;
}

.dashboard-container.sidebar-collapsed {
  grid-template-columns: var(--sidebar-collapsed-width) -1fr;
}

.main-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  margin-left: var(--sidebar-width);
  transition: margin-left var(--transition-speed) ease;
  width: calc(100% - var(--sidebar-width));
}

.sidebar-collapsed .main-container {
  margin-left: var(--sidebar-collapsed-width);
}

.content-wrapper {
  flex: 1;
  padding: 2rem;
  margin-top: var(--topbar-height);
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
  width: 100%;
}

@media (max-width: 992px) {
  .content-wrapper {
    padding: 1.5rem;
  }
}

@media (max-width: 768px) {
  .main-container {
    margin-left: 0;
    width: 100%;
  }
  
  .content-wrapper {
    padding: 1rem;
  }
  
  .container {
    padding: 0 0.5rem;
  }
}

.content-wrapper {
  flex: 1;
  padding: 2rem;
  margin-top: var(--topbar-height);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== SIDEBAR ===== */
/* Sidebar */
.sidebar {
  background: linear-gradient(195deg, #007ec7, #02204e);
  color: white;
  padding: 1rem 0;
  width: var(--sidebar-width);
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  transition: transform var(--transition-speed) ease;
  z-index: 100;
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
}

.sidebar .logo {
  font-size: 1.2rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  margin-bottom: 1rem;
  color: white;
}

.sidebar .logo i {
  font-size: 1.5rem;
}

.nav-menu {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
  padding: 0 0.75rem;
}

.nav-section {
  margin-top: 1.5rem;
  padding-left: 0.75rem;
}

.nav-section h3 {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05rem;
  margin-bottom: 0.5rem;
  padding-left: 0.5rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  color: #b8c2cc;
  text-decoration: none;
  transition: all var(--transition-speed) ease;
  border-radius: var(--card-radius);
  font-size: 0.9rem;
}

.nav-item:hover,
.nav-item.active {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.nav-item i {
  width: 20px;
  text-align: center;
  font-size: 1rem;
}

/* Main Content */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 1.5rem;
  margin-top: var(--topbar-height);
  background-color: var(--background-color);
}

/* Top Bar */
.top-bar {
    position: fixed;
    top: 0;
    left: var(--sidebar-width);
    right: 0;
    height: var(--topbar-height);
    background: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    box-shadow: var(--box-shadow);
    z-index: 99;
}

.top-bar .search-bar {
    flex: 1;
    max-width: 400px;
    margin-right: 1rem;
}

.top-bar .search-bar input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e0e0e0;
    border-radius: var(--card-radius);
    font-size: 0.9rem;
    background-color: #f5f5f5;
}

.top-bar .user-menu {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.top-bar .notification-bell {
    position: relative;
    cursor: pointer;
}

.top-bar .notification-bell i {
    font-size: 1.2rem;
    color: #555;
}

.top-bar .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--primary-color);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.75rem;
}

/* --- Top Bar Dropdown Fix --- */
.top-bar .user-profile {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.top-bar .dropdown-menu {
    display: none;
    position: absolute;
    background-color: white;
    box-shadow: var(--box-shadow);
    border-radius: var(--card-radius);
    overflow: hidden;
    z-index: 1000;
    right: 0;
    top: 110%;
    min-width: 180px;
    animation: fadeIn 0.2s;
}

.top-bar .user-profile.open .dropdown-menu {
    display: block;
}

.top-bar .dropdown-menu a {
    color: #333;
    padding: 0.75rem 1.5rem;
    text-decoration: none;
    display: block;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.top-bar .dropdown-menu a:hover {
    background-color: #f0f0f0;
}


/* ===== PAGE HEADER ===== */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  width: 100%;
  max-width: 1400px;
}

.page-header h1 {
  font-size: 1.75rem;
  font-weight: 600;
  color: var(--text-primary);
}

/* ===== BUTTONS ===== */
.primary-btn {
  background-color: var(--primary-color);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: var(--input-radius);
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
}

.primary-btn:hover {
  background-color: var(--primary-dark);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.secondary-btn {
  background-color: white;
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  padding: 0.75rem 1.5rem;
  border-radius: var(--input-radius);
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
}

.secondary-btn:hover {
  background-color: var(--primary-light);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.danger-btn {
  background-color: var(--danger-color);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: var(--input-radius);
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
}

.danger-btn:hover {
  background-color: #dc2626;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.link-btn {
  background: none;
  border: none;
  color: var(--primary-color);
  padding: 0.5rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
}

.link-btn:hover {
  color: var(--primary-dark);
  text-decoration: underline;
}

    /* Additional styles for product management */
    .product-management {
      display: flex;
      gap: 2rem;
    }

    .frame {
      flex: 1;
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: var(--card-radius);
      background-color: white;
    }

    .frame-left {
      width: 300px; /* Fixed width */
      height: 600px; /* Fixed height */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      border-radius: var(--card-radius);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .frame-right {
      max-height: 600px;
      overflow-y: auto;
      position: relative; /* Add relative positioning */
    }

    .search-bar-frame {
      position: sticky; /* Fix the search bar at the top */
      top: 0;
      background-color: white; /* Ensure background color matches */
      z-index: 10; /* Ensure it stays above other elements */
      padding: 0.5rem 0; /* Add padding for spacing */
      border-bottom: 1px solid #e2e8f0; /* Add a separator below the search bar */
    }

    .search-bar-frame input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: var(--card-radius);
    }

    .product-item {
      display: grid;
      grid-template-columns: 1fr auto; /* Separate text and buttons into their own "frames" */
      align-items: center; /* Ensure vertical alignment */
      padding: 0.75rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: var(--card-radius);
      margin-bottom: 0.5rem;
    }

    .product-item button {
      font-size: 0.7rem; /* Slightly smaller font size */
      border: none;
      cursor: pointer;
      padding: 0.3rem 0.6rem; /* Adjust padding */
      border-radius: var(--card-radius);
      transition: background-color 0.3s ease;
    }

    .product-item .edit-btn {
      background-color: #fbbf24; /* Yellowish orange */
      color: white;
    }

    .product-item .delete-btn {
      background-color: #ef4444; /* Red */
      color: white;
    }

    .product-item .edit-btn:hover {
      background-color: #f59e0b; /* Darker yellowish orange */
    }

    .product-item .delete-btn:hover {
      background-color: #dc2626; /* Darker red */
    }

    #product-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
    }

    #product-form label {
      align-self: flex-start;
      font-weight: 600;
      color: var(--primary-color);
    }

    #product-form input,
    #product-form select,
    #product-form button {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: var(--card-radius);
      font-size: 0.9rem;
    }

    #product-form input:focus,
    #product-form select:focus,
    #product-form button:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 126, 199, 0.2);
    }

    #other-vat-container {
      display: none;
      width: 100%;
    }

    #other-vat-container label {
      font-weight: 600;
      color: var(--primary-color);
    }

    #other-vat-container input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: var(--card-radius);
      font-size: 0.9rem;
    }

    #other-vat-container input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 126, 199, 0.2);
    }

    #product-form button {
      background-color: var(--primary-color); /* Blue */
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: var(--card-radius);
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #product-form button:hover {
      background-color: #005fa3; /* Darker blue */
    }

    .search-bar-frame,
    #product-list h3 {
      position: sticky; /* Fix both the search bar and header */
      top: 0;
      background-color: white;
      z-index: 10;
      padding: 0.5rem 0;
    }

    #product-list h3 {
      margin: 0; /* Remove default margin for better alignment */
      border-bottom: 1px solid #e2e8f0; /* Add a separator */
      position: sticky; /* Fix the header below the search bar */
      top: 2.5rem; /* Adjust to account for the search bar height */
      background-color: white;
      z-index: 9; /* Ensure it stays below the search bar */
      padding: 0.5rem 0;
      border-bottom: 1px solid #e2e8f0; /* Add a separator below the header */
    }
  </style>

</head>
<body onload="loadSidebar()">
  <div class="dashboard-container">
    <!-- Sidebar Menu -->
    <nav class="sidebar">
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <span>WALAKA</span>
      </div>
      <div class="nav-menu">
        <a href="dashboard.html" class="nav-item">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
        <div class="nav-section">
          <h3>Facturação</h3>
        </div>
        <a href="invoices.html" class="nav-item">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Facturas</span>
        </a>
        <a href="clients/clients.html" class="nav-item">
          <i class="fas fa-users"></i>
          <span>Clientes</span>
        </a>
        <a href="products.html" class="nav-item active">
          <i class="fas fa-shopping-cart"></i>
          <span>Produtos</span>
        </a>
        <!--
        <div class="nav-section">
          <h3>Comercial</h3>
        </div>
        <a href="#" class="nav-item">
          <i class="fas fa-boxes"></i>
          <span>Inventário</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-truck"></i>
          <span>Fornecedores</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-exchange-alt"></i>
          <span>Movimentos</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-money-bill-wave"></i>
          <span>Despesas</span>
        </a>
        <div class="nav-section">
          <h3>Contabilidade</h3>
        </div>
        <a href="#" class="nav-item">
          <i class="fas fa-book"></i>
          <span>Lançamentos</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-list-alt"></i>
          <span>Plano de contas</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-percent"></i>
          <span>Impostos</span>
        </a>
        <div class="nav-section">
          <h3>Finanças</h3>
        </div>
        <a href="#" class="nav-item">
          <i class="fas fa-chart-pie"></i>
          <span>Relatórios</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-chart-line"></i>
          <span>Indicadores-chave</span>
        </a>
        -->
        <div class="nav-section">
          <h3>Settings</h3>
        </div>
        <a href="settings.html" class="nav-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
        <a href="usermanagement-vanilla/index.html" class="nav-item">
          <i class="fas fa-user-cog"></i>
          <span>Gestão de Utilizadores</span>
        </a>
        <a href="#" class="nav-item">
          <i class="fas fa-question-circle"></i>
          <span>Ajuda</span>
        </a>
      </div>
    </nav>
    <!-- Main Content Area -->
    <main class="main-container">
      <header class="top-bar">
        <div class="hamburger-menu" id="hamburger-menu">
          <i class="fas fa-bars"></i>
        </div>
        <div class="user-menu" style="margin-left:auto;">
          <div class="notification-bell">
            <i class="fas fa-bell"></i>
            <span class="badge">3</span>
          </div>
          <div class="user-profile" id="userProfile">
            <div class="avatar">
              <i class="fas fa-user"></i>
            </div>
            <span id="user-displayname">Loading...</span>
            <div class="dropdown-menu" id="userDropdown">
              <a href="#"><i class="fas fa-user-circle"></i> My Profile</a>
              <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
              <a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
          </div>
        </div>
      </header>

      <div class="content-wrapper">
        <div class="container">
          <div class="page-header">
            <h1>Product Management</h1>
            <button id="add-new-product-btn" class="primary-btn">
              <i class="fas fa-plus"></i> Add New Product
            </button>
          </div>

          <div class="product-management">
            <!-- Product Form Section -->
            <section class="frame frame-left" id="product-form-container">
              <h2 id="form-title">Novo Produto</h2>
              <form id="product-form">
                <div class="form-group">
                  <label for="description">Description <span class="required">*</span></label>
                  <input type="text" id="description" name="description" required placeholder="Product description">
                </div>

                <div class="form-group">
                  <label for="price">Price <span class="required">*</span></label>
                  <input type="number" id="price" name="price" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                  <label for="tax-code">Tax Code (SAT) <span class="required">*</span></label>
                  <input type="text" id="tax-code" name="tax-code" required placeholder="e.g. 10101">
                </div>

                <div class="form-group">
                  <label for="vat">Tax Rate (VAT) <span class="required">*</span></label>
                  <select id="vat" name="vat" required>
                    <option value="0.16">16%</option>
                    <option value="0.05">5%</option>
                    <option value="0">Exempt</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="form-group" id="other-vat-container" style="display: none;">
                  <label for="other-vat">Other VAT Percentage</label>
                  <input type="number" id="other-vat" name="other-vat" min="0" max="100" step="0.01" placeholder="Enter custom VAT rate">
                </div>

                <div class="form-group">
                  <label for="industry">Industry (SAT) <span class="required">*</span></label>
                  <input type="text" id="industry" name="industry" required placeholder="e.g. Retail">
                </div>

                <div class="form-footer">
                  <button type="submit" id="save-product-btn" class="primary-btn">Save Product</button>
                  <button type="button" id="cancel-btn" class="secondary-btn">Cancel</button>
                </div>
              </form>
            </section>

            <!-- Product List Section -->
            <section class="frame frame-right">
              <div class="list-controls">
                <div class="search-filter-container">
                  <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="product-search" placeholder="Search products...">
                  </div>
                  <div class="filter-group">
                    <select id="industry-filter">
                      <option value="all">All Industries</option>
                      <option value="retail">Retail</option>
                      <option value="manufacturing">Manufacturing</option>
                      <option value="services">Services</option>
                    </select>
                    <select id="vat-filter">
                      <option value="all">All VAT Rates</option>
                      <option value="16">16%</option>
                      <option value="5">5%</option>
                      <option value="0">Exempt</option>
                    </select>
                  </div>
                </div>
                <div class="view-toggle">
                  <button id="grid-view-btn" class="active">
                    <i class="fas fa-th-large"></i>
                  </button>
                  <button id="list-view-btn">
                    <i class="fas fa-list"></i>
                  </button>
                </div>
              </div>

              <div id="product-list" class="product-list grid-view">
                <!-- Products will be dynamically inserted here -->
              </div>

              <div class="pagination">
                <button id="prev-page" class="secondary-btn">
                  <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="page-info">Page 1 of 1</span>
                <button id="next-page" class="secondary-btn">
                  Next <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </section>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this product? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button id="confirm-delete-btn" class="danger-btn">Delete</button>
        <button id="cancel-delete-btn" class="secondary-btn">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm';

    const supabaseUrl = 'https://qvmtozjvjflygbkjecyj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2bXRvemp2amZseWdia2plY3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjc2MjMsImV4cCI6MjA2MTcwMzYyM30.DJMC1eM5_EouM1oc07JaoXsMX_bSLn2AVCozAcdfHmo';
 // Replace with your actual Supabase key
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function displayUserName() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) {
          console.error('Erro ao obter sessão:', error?.message);
          document.getElementById('user-name').textContent = 'Não logado';
          return;
        }

        const user = session.user;
        if (!user) {
          document.getElementById('user-name').textContent = 'Não logado';
          return;
        }

        const { data: profileData, error: profileError } = await supabase
          .from('users')
          .select('username, logo')
          .eq('id', user.id)
          .single();

        if (profileError) {
          console.error('Erro ao buscar perfil:', profileError.message);
          return;
        }

        const userNameSpan = document.getElementById('user-name');
        if (userNameSpan) {
          userNameSpan.textContent = profileData.username || 'Usuário Desconhecido';
        }

        const userAvatar = document.querySelector('.avatar');
        if (userAvatar && profileData.logo) {
          userAvatar.innerHTML = `<img src="${profileData.logo}" alt="User Logo" style="width: 100%; height: 100%; border-radius: 50%;">`;
        }
      } catch (err) {
        console.error('Erro inesperado:', err);
      }
    }

    window.addEventListener('DOMContentLoaded', displayUserName);

    async function handleSignOut() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Erro ao sair:', error);
      } else {
        window.location.href = '/login.html';
      }
    }

    let products = [];

    function formatCurrency(value) {
      return `MZN ${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ').replace('.', ',')}`;
    }

    function formatVatForDisplay(vat) {
      return `${(vat * 100).toFixed(0)}%`; // Convert decimal to percentage for display
    }

    function parseVatFromDisplay(vatDisplay) {
      return parseFloat(vatDisplay.replace('%', '')); // Convert percentage back to decimal for storage
    }

    async function fetchProducts() {
      // Obter o usuário logado
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError || !session || !session.user) {
        console.error('Erro ao obter sessão:', sessionError?.message);
        return;
      }
      const userId = session.user.id;
      // Buscar apenas produtos do usuário logado
      const { data, count, error } = await supabase
        .from('products')
        .select('*', { count: 'exact' })
        .eq('user_id', userId);

      if (error) {
        console.error('Error fetching products:', error);
        return;
      }

      products = data;
      displayProducts();

      // Update product count in the header
      const productListHeader = document.querySelector('#product-list h3');
      if (productListHeader) {
        productListHeader.textContent = `Product List (${count || 0})`;
      }
    }

    async function saveProduct() {
      // Obter o usuário logado
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError || !session || !session.user) {
        alert('Usuário não autenticado. Faça login novamente.');
        return;
      }
      const userId = session.user.id;
      const description = document.getElementById('description').value;
      const price = parseFloat(document.getElementById('price').value);
      const taxCode = document.getElementById('tax-code').value;
      const taxRate = parseFloat(document.getElementById('vat').value);
      const industry = document.getElementById('industry').value;

      if (!description || isNaN(price) || !taxCode || isNaN(taxRate) || !industry) {
        alert('Please fill in all required fields.');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('products')
          .insert([{ description, price, tax_code: taxCode, tax_rate: taxRate, industry, user_id: userId }])
          .select();

        if (error) {
          alert('Error saving product: ' + error.message);
          return;
        }

        products.push(data[0]);
        displayProducts();
        document.getElementById('product-form').reset();
      } catch (err) {
        alert('Unexpected error: ' + err.message);
      }
    }

    async function logProductUpdate(productId, oldData, newData, userId) {
      await supabase.from('product_updates').insert([
        {
          product_id: productId,
          old_data: JSON.stringify(oldData),
          new_data: JSON.stringify(newData),
          updated_by: userId
        }
      ]);
    }

    async function editProduct(index) {
      const product = products[index];
      document.getElementById('description').value = product.description;
      document.getElementById('price').value = product.price;
      document.getElementById('vat').value = product.vat === 0 ? '0' : formatVatForDisplay(product.vat);
      if (document.getElementById('vat').value === 'other') {
        document.getElementById('other-vat-container').style.display = 'block';
        document.getElementById('other-vat').value = (product.vat * 100).toFixed(0); // Show as percentage
      } else {
        document.getElementById('other-vat-container').style.display = 'none';
      }

      const saveButton = document.querySelector('#product-form button[type="button"]');
      saveButton.textContent = 'Update Product';
      saveButton.onclick = async function () {
        const updatedDescription = document.getElementById('description').value;
        const updatedPrice = parseFloat(document.getElementById('price').value);
        const updatedVatDisplay = document.getElementById('vat').value === 'other' 
          ? `${document.getElementById('other-vat').value}%` 
          : document.getElementById('vat').value;
        const updatedVat = parseVatFromDisplay(updatedVatDisplay);
        const updatedTaxCode = document.getElementById('tax-code').value;
        const updatedTaxRate = parseFloat(document.getElementById('tax-rate').value);
        const updatedIndustry = document.getElementById('industry').value;

        // Obter usuário logado
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        const userId = session?.user?.id || null;

        const oldData = { ...product };
        const newData = {
          description: updatedDescription,
          price: updatedPrice,
          vat: updatedVat,
          tax_code: updatedTaxCode,
          tax_rate: updatedTaxRate,
          industry: updatedIndustry
        };

        const { error } = await supabase
          .from('products')
          .update(newData)
          .eq('id', product.id);

        if (!error) {
          await logProductUpdate(product.id, oldData, newData, userId);
          products[index] = { ...product, ...newData };
          displayProducts();
          document.getElementById('product-form').reset();
          document.getElementById('other-vat-container').style.display = 'none';
          saveButton.textContent = 'Save';
          saveButton.onclick = saveProduct;
        } else {
          console.error('Error updating product:', error);
        }
      };
    }

    async function deleteProduct(index) {
      const product = products[index];
      const { error } = await supabase.from('products').delete().eq('id', product.id);
      if (error) {
        console.error('Error deleting product:', error);
        return;
      }
      products.splice(index, 1);
      displayProducts();
    }

    function displayProducts() {
      const productList = document.getElementById('product-list');
      productList.innerHTML = '<h3>Product List</h3>';
      products.forEach((product, index) => {
        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.innerHTML = `
          <span>
            ${product.description} - ${formatCurrency(product.price)}<br>
            <strong>Tax Code:</strong> ${product.tax_code} | 
            <strong>Tax Rate:</strong> ${product.tax_rate}% | 
            <strong>Industry:</strong> ${product.industry}
          </span>
          <div>
            <button class="edit-btn" onclick="editProduct(${index})">Update Product</button>
          </div>
        `;
        productList.appendChild(productItem);
      });
    }

    function subscribeToProducts() {
      supabase
        .channel('products-changes')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'products' },
          (payload) => {
            console.log('Change received:', payload);
            fetchProducts(); // Refresh the product list on any change
          }
        )
        .subscribe();
    }

    // Attach functions to the global window object
    window.saveProduct = saveProduct;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.filterProducts = filterProducts; // Attach filterProducts globally

    window.addEventListener('DOMContentLoaded', () => {
      fetchProducts();
      subscribeToProducts(); // Start listening for real-time updates
    });

    function filterProducts() {
      const searchTerm = document.getElementById('search-bar').value.toLowerCase();
      const productItems = document.querySelectorAll('.product-item');

      productItems.forEach((item) => {
        const productText = item.querySelector('span').textContent.toLowerCase();
        if (productText.includes(searchTerm)) {
          item.style.display = 'grid';
        } else {
          item.style.display = 'none';
        }
      });
    }

        //Display user name function
        // This function will fetch the username from the Supabase database and display it
        // in the user-displayname span element
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof supabase === 'undefined') return;

            const { data: { session } } = await supabase.auth.getSession();
            if (!session || !session.user) return;

            let displayName = session.user.email;
            try {
                const { data: userRecord, error } = await supabase
                    .from('users')
                    .select('username')
                    .eq('id', session.user.id)
                    .maybeSingle();

                if (userRecord && userRecord.username) {
                    displayName = userRecord.username;
                }
            } catch (e) {
                // fallback to email
            }

            const userSpan = document.getElementById('user-displayname');
            if (userSpan) userSpan.textContent = displayName;

        });

        // Dropdown open/close logic for user menu
        const userProfile = document.getElementById('userProfile');
        const userDropdown = document.getElementById('userDropdown');

        let dropdownTimeout;

        function openDropdown() {
            clearTimeout(dropdownTimeout);
            userProfile.classList.add('open');
        }
        function closeDropdown() {
            dropdownTimeout = setTimeout(() => {
                userProfile.classList.remove('open');
            }, 150);
        }

        userProfile.addEventListener('mouseenter', openDropdown);
        userProfile.addEventListener('mouseleave', closeDropdown);
        userDropdown.addEventListener('mouseenter', openDropdown);
        userDropdown.addEventListener('mouseleave', closeDropdown);

        // Optional: close on click outside
        document.addEventListener('click', function(e) {
            if (!userProfile.contains(e.target)) {
                userProfile.classList.remove('open');
            }
        });

  </script>
</body>
</html>