<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="create_invoice_title">WALAKA - Create Invoice</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/invoice.css">
    <script src="https://cdn.supabase.com/supabase-js-v2.min.js"></script>
    <style>
        /* Estilos CSS para o dropdown */
        .select-wrapper {
            position: relative;
            user-select: none;
            flex-grow: 1;
            min-width: 200px; /* Ajuste a largura conforme necess√°rio */
        }

        .select-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            background-color: #fff;
            border-width: 1px;
            border-color: #d1d5db;
            border-radius: 0.375rem;
            color: #374151;
            cursor: pointer;
            transition: border-color 0.15s ease-in-out, shadow-sm 0.15s ease-in-out;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .select-trigger:hover,
        .select-wrapper:focus-within .select-trigger {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .select-trigger span {
            margin-right: 0.5rem;
        }

        .select-trigger svg {
            height: 1rem;
            width: 1rem;
            fill: currentColor;
            color: #4b5563;
        }

        .select-options {
            position: fixed; /* Mudado para fixed */
            top: 100%;
            left: 0;
            right: auto;
            z-index: 20;
            background-color: #fff;
            border-width: 1px;
            border-color: #d1d5db;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
            overflow: auto;
            max-height: 200px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.15s ease-in-out, visibility 0.15s ease-in-out, transform 0.15s ease-in-out;
        }

        .select-wrapper.open .select-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }


        .select-options li {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            white-space: nowrap;
        }

        .select-options li:hover,
        .select-options li.selected {
            background-color: #f0f9ff;
            color: #1e293b;
        }

        .select-options li.selected {
            font-weight: 600;
        }

        .select-wrapper select {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>WALAKA</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span data-translate="dashboard">Dashboard</span>
                </a>
                
                <div class="nav-section">
                    <h3 data-translate="invoices_sales">Invoices & Sales</h3>
                </div>
                <a href="invoices.html" class="nav-item active">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span data-translate="invoices">Invoices</span>
                </a>
                <a href="products.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span data-translate="products">Products</span>
                </a>
                <a href="clients/clients/clients.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span data-translate="clients">Clients</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-percentage"></i>
                    <span data-translate="taxes">Taxes</span>
                </a>
                
                <div class="nav-section">
                    <h3 data-translate="finances">Finances</h3>
                </div>
                <a href="#" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span data-translate="expenses">Expenses</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-chart-pie"></i>
                    <span data-translate="reports">Reports</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span data-translate="payments">Payments</span>
                </a>
                
                <div class="nav-section">
                    <h3 data-translate="inventory">Inventory</h3>
                </div>
                <a href="#" class="nav-item">
                    <i class="fas fa-boxes"></i>
                    <span data-translate="stock">Stock</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-truck"></i>
                    <span data-translate="suppliers">Suppliers</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span data-translate="movements">Movements</span>
                </a>
                
                <div class="nav-section">
                    <h3 data-translate="settings">Settings</h3>
                </div>
                <a href="#" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span data-translate="settings">Settings</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-user-cog"></i>
                    <span data-translate="account">Account</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-question-circle"></i>
                    <span data-translate="help">Help</span>
                </a>
            </div>
        </nav>
        
        <div class="main-content">
            <div class="top-bar">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="search-bar">
                    <input type="text" data-translate-placeholder="search_placeholder" placeholder="Search...">
                </div>
                
                <div class="user-menu">
                    <div class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                    
                    <div class="user-profile">
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span>John Doe</span>
                        <div class="dropdown-menu">
                            <a href="#">
                                <i class="fas fa-user-circle"></i> <span data-translate="my_profile">My Profile</span>
                            </a>
                            <a href="#">
                                <i class="fas fa-cog"></i> <span data-translate="settings">Settings</span>
                            </a>
                            <a href="#">
                                <i class="fas fa-sign-out-alt"></i> <span data-translate="logout">Logout</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-header">
                <div>
                    <h2 data-translate="create_invoice">Create Invoice</h2>
                    <p class="subtitle" data-translate="create_invoice_subtitle">Fill out the form below to create a new invoice</p>
                </div>
                <div class="action-buttons">
                    <a href="invoices.html" class="btn secondary-btn">
                        <i class="fas fa-arrow-left"></i> <span data-translate="back_to_invoices">Back to Invoices</span>
                    </a>
                </div>
            </div>
            
            <div class="page-header">
                <div>
                    <h2 data-translate="existing_invoices">Existing Invoices</h2>
                    <p class="subtitle" data-translate="existing_invoices_subtitle">A list of existing invoices</p>
                </div>
            </div>
            <div id="invoices-container">
            </div>
            
            <div class="create-invoice-container">
                <form id="invoiceForm" class="create-invoice-form">
                    <div class="form-grid">
                        <div class="form-section">
                            <h3 data-translate="client_information">Client Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clientSelect" data-translate="client_name_company">Client Name/Company</label>
                                    <div class="select-wrapper" id="clientSelectWrapper">
                                        <div class="select-trigger">
                                            <span data-translate="select_a_client">Select a client</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                        </div>
                                        <div class="select-options">
                                            <select id="clientSelect" required>
                                                <option value="" disabled selected data-translate="select_a_client">Select a client</option>
                                            </select>
                                            <ul>
                                            </ul>
                                        </div>
                                    </div>
                                    <button type="button" class="btn secondary-btn" id="addClientBtn" onclick="redirectToClients()">
                                        <i class="fas fa-plus"></i> <span data-translate="add_client">Add Client</span>
                                    </button>
                                </div>
                                <div class="form-group">
                                    <label for="clientEmail" data-translate="email">Email</label>
                                    <input type="email" id="clientEmail" data-translate-placeholder="client_email_placeholder" placeholder="client@example.com">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clientAddress" data-translate="address">Address</label>
                                    <textarea id="clientAddress" rows="3" data-translate-placeholder="client_address_placeholder" placeholder="Client's full address"></textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clientTaxId" data-translate="tax_id_nuit">Tax ID (NUIT)</label>
                                    <input type="text" id="clientTaxId" data-translate-placeholder="tax_id_placeholder" placeholder="e.g. 123456789">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 data-translate="invoice_details">Invoice Details</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="invoiceNumber" data-translate="invoice_number">Invoice Number</label>
                                    <input type="text" id="invoiceNumber" data-translate-value="generating_invoice_number" value="Generating invoice number" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="issueDate" data-translate="issue_date">Issue Date</label>
                                    <input type="date" id="issueDate" value="2025-03-25" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dueDate" data-translate="due_date">Due Date</label>
                                    <input type="date" id="dueDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="currency" data-translate="currency">Currency</label>
                                    <select id="currency" required>
                                        <option value="USD" selected>USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - British Pound</option>
                                        <option value="MZN">MZN - Mozambican Metical</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paymentTerms" data-translate="payment_terms">Payment Terms</label>
                                    <select id="paymentTerms" required>
                                        <option value="net30" selected data-translate="net_30">Net 30 - Due in 30 days</option>
                                        <option value="net15" data-translate="net_15">Net 15 - Due in 15 days</option>
                                        <option value="net60" data-translate="net_60">Net 60 - Due in 60 days</option>
                                        <option value="custom" data-translate="custom">Custom</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="issuerName" data-translate="issuer_name">Issuer Name</label>
                                    <input type="text" id="issuerName" data-translate-placeholder="issuer_name_placeholder" placeholder="Issuer Name" required>
                                </div>
                                <div class="form-group">
                                    <label for="issuerNuit" data-translate="issuer_nuit">Issuer NUIT</label>
                                    <input type="text" id="issuerNuit" data-translate-placeholder="issuer_nuit_placeholder" placeholder="Issuer NUIT">
                                </div>
                            </div>
                            <div class="form-row">
                                 <div class="form-group">
                                    <label for="issuerAddress" data-translate="issuer_address">Issuer Address</label>
                                    <textarea id="issuerAddress" rows="2" data-translate-placeholder="issuer_address_placeholder" placeholder="Issuer Address"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 data-translate="items">Items</h3>
                        <div class="items-table-container">
                            <table id="itemsTable" class="items-table">
                                <thead>
                                    <tr>
                                        <th width="40%" data-translate="description">Description</th>
                                        <th width="15%" data-translate="quantity">Quantity</th>
                                        <th width="15%" data-translate="unit_price">Unit Price</th>
                                        <th width="10%" data-translate="vat_16">VAT (16%)</th>
                                        <th width="15%" data-translate="total">Total</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="item-row">
                                        <td>
                                            <input type="text" class="item-description" data-translate-placeholder="item_description_placeholder" placeholder="Enter item description">
                                        </td>
                                        <td>
                                            <input type="number" class="item-quantity" value="1" min="1" step="1">
                                        </td>
                                        <td>
                                            <input type="number" class="item-price" value="0.00" min="0" step="0.01">
                                        </td>
                                        <td>
                                            <span class="item-vat">0.00</span>
                                        </td>
                                        <td>
                                            <span class="item-total">0.00</span>
                                        </td>
                                        <td>
                                            <button type="button" class="remove-item-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button type="button" id="addItemBtn" class="btn secondary-btn">
                            <i class="fas fa-plus"></i> <span data-translate="add_item">Add Item</span>
                        </button>
                        
                        <div class="invoice-totals">
                            <div class="totals-row">
                                <span data-translate="subtotal">Subtotal:</span>
                                <span id="subtotal">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span data-translate="vat_16_total">VAT (16%):</span>
                                <span id="totalVat">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span data-translate="total">Total:</span>
                                <span id="invoiceTotal">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 data-translate="notes_terms">Notes & Terms</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="notes" data-translate="additional_notes">Additional Notes</label>
                                <textarea id="notes" rows="3" data-translate-placeholder="additional_notes_placeholder" placeholder="Add any additional notes or terms..."></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paymentConditions" data-translate="payment_conditions">Payment Conditions</label>
                                <textarea id="paymentConditions" rows="2" data-translate-placeholder="payment_conditions_placeholder" placeholder="Payment Conditions"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="legalInfo" data-translate="legal_information">Legal Information</label>
                                <textarea id="legalInfo" rows="2" data-translate-placeholder="legal_information_placeholder" placeholder="Legal Information"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-footer">
                        <button type="button" class="btn secondary-btn" id="chooseTemplate">
                            <i class="fas fa-save"></i> <span data-translate="choose_template">Choose Template</span>
                        </button>
                        <button type="button" class="btn secondary-btn" id="previewInvoiceBtn">
                            <i class="fas fa-eye"></i> <span data-translate="preview">Preview</span>
                        </button>
                        <button type="submit" class="btn primary-btn">
                            <i class="fas fa-check"></i> <span data-translate="create_invoice">Create Invoice</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js"></script>
    <script src="js/invoice.js"></script>
    <script src="js/invoicescripts/templateManager.js"></script>
    <script>
        // Initialize the Supabase client
        const SUPABASE_URL = 'https://icirwhacigwjrxisvayj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljaXJ3aGFjaWd3anJ4aXN2YXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkyNzc5NzQsImV4cCI6MjA1NDg1Mzk3NH0.A8bVciC-NDwYoWMP8ijXBgNlEplYNTf6VGVe5G7SnFk';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Fun√ß√£o para buscar clientes do Supabase
        async function fetchClients() {
            const { data: clients, error } = await supabase
                .from('clients')
                .select('id, client_name');

            if (error) {
                console.error('Erro ao buscar clientes:', error);
                return;
            }

            const clientSelect = document.getElementById('clientSelect');
            const clientSelectOptionsList = document.querySelector('.select-options ul');
            const selectTriggerSpan = document.querySelector('.select-trigger span');
            const selectWrapper = document.getElementById('clientSelectWrapper');


            // Limpa as op√ß√µes existentes
            clientSelect.innerHTML = '<option value="" disabled selected>Selecione um cliente</option>';
            clientSelectOptionsList.innerHTML = '';

            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.client_name;
                clientSelect.appendChild(option);

                const li = document.createElement('li');
                li.textContent = client.client_name;
                li.dataset.value = client.id;  // Armazena o ID do cliente no dataset
                clientSelectOptionsList.appendChild(li);
            });

            // Event listeners para o dropdown interativo
            const selectTrigger = document.querySelector('.select-trigger');
            const selectOptions = document.querySelector('.select-options');

            selectTrigger.addEventListener('click', () => {
                selectWrapper.classList.toggle('open');
                if (selectWrapper.classList.contains('open')) {
                    // Reposiciona e redimensiona o dropdown quando aberto
                    const triggerRect = selectTrigger.getBoundingClientRect();
                    selectOptions.style.top = triggerRect.bottom + 'px';
                    selectOptions.style.left = triggerRect.left + 'px';
                    selectOptions.style.width = triggerRect.width + 'px';
                }
            });

            selectOptions.addEventListener('click', (event) => {
                if (event.target.tagName === 'LI') {
                    const value = event.target.dataset.value;
                    const text = event.target.textContent;

                    clientSelect.value = value;
                    selectTriggerSpan.textContent = text;
                    selectWrapper.classList.remove('open');
                }
            });

            // Fecha o dropdown quando clica fora
            document.addEventListener('click', (event) => {
                if (!selectWrapper.contains(event.target) && !selectOptions.contains(event.target)) {
                    selectWrapper.classList.remove('open');
                }
            });

            // Atualiza o texto do trigger quando o select ‡¶Ü‡¶∏‡¶≤ mudado via teclado ou outro m√©todo
            clientSelect.addEventListener('change', () => {
                const selectedOptionText = clientSelect.options[clientSelect.selectedIndex].text;
                selectTriggerSpan.textContent = selectedOptionText;
            });
        }

        function redirectToClients() {
            window.location.href = 'clients/clients.html';
        }

        // Call fetchClients when the page loads
        window.addEventListener('load', () => {
          fetchClients();
          displayInvoices(); // Chama a fun√ß√£o para exibir as invoices
        });

        // Fetch data from the invoices table
        async function fetchInvoices() {
            let { data: invoices, error } = await supabase
                .from('invoices')
                .select('*'); // Select all columns

            if (error) {
                console.error('Error fetching invoices:', error);
                return [];
            }

            return invoices;
        }

        // Display the invoices on your page
        async function displayInvoices() {
            const invoices = await fetchInvoices();
            const invoicesContainer = document.getElementById('invoices-container');

            if (invoicesContainer) {
                invoices.forEach(invoice => {
                    const invoiceElement = document.createElement('div');
                    invoiceElement.innerHTML = `
                        <h2>Invoice #${invoice.invoiceNumber}</h2>
                        <p>Issue Date: ${invoice.issue_date}</p>
                        <p>Issuer: ${invoice.issuer_name} (${invoice.issuer_nuit}), ${invoice.issuer_address}</p>
                        <p>Client: ${invoice.client_name} (${invoice.client_nuit}), ${invoice.client_address}</p>
                        <p>Description: ${invoice.description}</p>
                        <p>Total (Excl. VAT): ${invoice.total_without_taxes}</p>
                        <p>VAT Rate: ${invoice.vat_rate}%</p>
                        <p>VAT Amount: ${invoice.vat_amount}</p>
                        <p>Total Payable: ${invoice.total_amount_payable}</p>
                        <p>Payment Conditions: ${invoice.payment_conditions}</p>
                        <p>Legal Info: ${invoice.legal_info}</p>
                        <p>Created At: ${invoice.created_at}</p>
                        <p>User ID: ${invoice.user_id}</p>
                        <p>ID: ${invoice.id}</p>
                    `;
                    invoicesContainer.appendChild(invoiceElement);
                });
            } else {
                console.error('Invoices container not found.');
            }
        }

    </script>
    <script src="services/languageManager.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        if (window.languageManager) {
          const lang = localStorage.getItem('preferredLanguage') || 'pt';
          window.languageManager.setLanguage(lang);
        }
      });
    </script>
</body>
</html>
