<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WALAKA - Invoice Management</title>
    <script>
        // Set base path for assets to handle GitHub Pages sub-directory
        const repoName = 'Walaka';
        const isGitHubPages = window.location.hostname.includes('github.io');
        const basePath = isGitHubPages ? `/${repoName}/` : '/';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <script>
        document.write(`<link rel="stylesheet" href="${basePath}trial/css/upgrade-modal.css">`);
        document.write(`<link rel="stylesheet" href="${basePath}components/trial-banner.css">`);
        document.write(`<link rel="stylesheet" href="${basePath}components/trial-restrictions.css">`);
        document.write(`<link rel="stylesheet" href="${basePath}components/sidebar.css">`);
        document.write(`<link rel="stylesheet" href="${basePath}css/styles.css">`);
        document.write(`<link rel="stylesheet" href="${basePath}css/invoice.css">`);
        document.write(`<link rel="stylesheet" href="${basePath}css/hints.css">`);
    </script>

    <!-- Custom JS -->

    <script src="js/invoicescripts/dateRangeFilter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar Menu -->
        <div id="sidebar-container"></div>
        <script>
        // Dynamically load the sidebar from components/sidebar.html
        document.addEventListener('DOMContentLoaded', function() {
            fetch(`${basePath}components/sidebar.html`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                    // Dynamically load the sidebar-actions.js script after sidebar is injected
                    var script = document.createElement('script');
                    script.src = `${basePath}components/sidebar-actions.js`;
                    document.body.appendChild(script);
                })
                .catch(err => {
                    console.error('Failed to load sidebar:', err);
                });
        });
        </script>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                
                <div class="user-menu" style="margin-left:auto;">
                    <a href="notifications.html" class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="badge">0</span>
                    </a>
                    
                    <div class="user-profile" id="userProfile">
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span id="user-displayname">Loading...</span>
                        <div class="dropdown-menu" id="userDropdown">
                            <a href="profile.html">
                                <i class="fas fa-user-circle"></i> My Profile
                            </a>
                            <a href="settings.html">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                            <a href="#">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add trial banner and restrictions system -->
            <div id="trial-banner-container"></div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                fetch(`${basePath}components/trial-banner.html`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(html => {
                        document.getElementById('trial-banner-container').innerHTML = html;
                        
                        // Load the banner script
                        const bannerScript = document.createElement('script');
                        bannerScript.type = 'module';
                        bannerScript.src = `${basePath}components/trial-banner.js`;
                        document.body.appendChild(bannerScript);
                        
                        // Load the restrictions script immediately after
                        const restrictionsScript = document.createElement('script');
                        restrictionsScript.src = `${basePath}components/trial-restrictions.js`;
                        document.body.appendChild(restrictionsScript);
                    })
                    .catch(error => {
                        console.error('Failed to load trial banner component:', error);
                    });
            });
            </script>
            
            <!-- Invoice Dashboard Content -->
            <div class="page-header">
                <div>
                    <h2 data-translate="invoice_management">Invoice Management</h2>
                    <p class="subtitle" data-translate="invoice_management_subtitle">Create, manage, and track all your invoices</p>
                </div>
                <div class="action-buttons">
                    <button class="btn primary-btn" id="createInvoiceBtn">
                        <i class="fas fa-plus"></i> <span data-translate="create_invoice">Create Invoice</span>
                    </button>
                </div>
            </div>
            
            <!-- Invoice Metrics -->
            <div class="metrics-grid">
                <div class="metric-card" id="totalInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-file-invoice"></i>
                        <span data-translate="total_invoices">Total Invoices</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label" data-translate="all_time">All Time</span>
                    </div>
                </div>
                
                <div class="metric-card" id="paidInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-check-circle"></i>
                        <span data-translate="paid_invoices">Paid Invoices</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label" data-translate="percent_of_total">% of Total</span>
                    </div>
                </div>
                
                <div class="metric-card" id="pendingInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-clock"></i>
                        <span data-translate="pending_payments">Pending Payments</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label" data-translate="percent_of_total">% of Total</span>
                    </div>
                </div>
                
                <div class="metric-card" id="overdueInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-exclamation-circle"></i>
                        <span data-translate="overdue_invoices">Overdue Invoices</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label" data-translate="percent_of_total">% of Total</span>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <h3>
                        <span data-translate="invoice_distribution">Invoices Sent</span>
                        <div class="chart-actions">
                            <select id="invoiceDistributionPeriod" class="chart-period-select">
                                <option value="last30" selected>Last 30 Days</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            <div id="invoiceDistributionCustomRange" class="custom-date-range" style="display: none; margin-left: 10px;">
                                <input type="date" id="invoiceDistributionStartDate" class="date-input">
                                <input type="date" id="invoiceDistributionEndDate" class="date-input">
                                <button id="applyInvoiceDistributionRange" class="btn btn-primary btn-sm">Apply</button>
                            </div>
                        </div>
                    </h3>
                    <div class="chart-container">
                        <canvas id="invoiceDistributionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3>
                        <span data-translate="revenue_by_status">Revenue by Status</span>
                        <div class="chart-actions">
                            <button id="revenueMonthlyBtn" class="chart-period-btn active" data-translate="monthly">Monthly</button>
                            <button id="revenueYearlyBtn" class="chart-period-btn" data-translate="yearly">Yearly</button>
                        </div>
                    </h3>
                    <div class="chart-container">
                        <canvas id="revenueByStatusChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Table Filter Section -->
            <div class="invoice-table-container">
                <div class="table-header">
                    <h3 data-translate="recent_invoices">Recent Invoices</h3>
                    <div class="table-filters">
                        <div class="filter-group">
                            <label for="statusFilter" data-translate="status_label">Status:</label>
                            <select id="statusFilter" class="filter-select">
                                <option value="all" data-translate="all_statuses">All Statuses</option>
                                <option value="paid" data-translate="paid">Paid</option>
                                <option value="pending" data-translate="pending">Pending</option>
                                <option value="overdue" data-translate="overdue">Overdue</option>
                                <option value="draft" data-translate="unfinished">Unfinished</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="clientFilter" data-translate="client">Client:</label>
                            <select id="clientFilter" class="filter-select">
                                <option value="all" data-translate="all_clients">All Clients</option>
                            </select>
                        </div>
     
                   <!--  Consolidated Date Range Filter -->
                        <div class="filter-group date-range-group">
                            <label for="dateRangeFilter" data-translate="date_range_label">Date Range:</label>
                            <select id="dateRangeFilter" class="filter-select">
                                <option value="all" data-translate="all_time">All Time</option>
                                <option value="today" data-translate="today">Today</option>
                                <option value="week" data-translate="this_week">This Week</option>
                                <option value="month" data-translate="this_month">This Month</option>
                                <option value="quarter" data-translate="this_quarter">This Quarter</option>
                                <option value="year" data-translate="this_year">This Year</option>
                                <option value="custom" data-translate="custom_range">Custom Range</option>
                            </select>
                            
                            <div id="customDateRange" class="custom-date-range" style="display: none;">
                                <div class="date-input-group">
                                    <label for="startDate">From:</label>
                                    <input type="date" id="startDate" class="date-input">
                                </div>
                                <div class="date-input-group">
                                    <label for="endDate">To:</label>
                                    <input type="date" id="endDate" class="date-input">
                                </div>
                                <button id="applyDateRange" class="btn btn-primary btn-sm">Apply</button>
                            </div>
                        </div>

                        <div class="search-filter">
                            <label for="searchInvoices" data-translate="search">Search:</label>
                            <input type="text" id="searchInvoices" data-translate-placeholder="search_invoices_placeholder" placeholder="Invoice number, client name...">
                            <button id="clearFilters" class="clear-filters-btn">
                                <i class="fas fa-times"></i> <span data-translate="clear">Clear</span>
                            </button>
                        </div>

                        <!-- Export Buttons -->
                        <div class="export-buttons">
                            <button id="exportCsvBtn" class="btn btn-success">
                                <i class="fas fa-file-csv"></i> <span data-translate="export_csv">Export CSV</span>
                            </button>
                            <button id="exportSaftBtn" class="btn btn-primary">
                                <i class="fas fa-file-code"></i> <span data-translate="export_saft">Export SAFT</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Invoices Table -->
                <div class="table-responsive">
                    <table id="invoicesTable" class="data-table">
                        <thead>
                            <tr>
                                <th data-translate="invoice_number">Invoice #</th>
                                <th data-translate="client">Client</th>
                                <th data-translate="date">Date</th>
                                <th data-translate="due_date">Due Date</th>
                                <th data-translate="amount">Amount</th>
                                <th data-translate="status">Status</th>
                                <th data-translate="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center">Loading invoices...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination">
                    <span class="page-info"></span>
                    <div class="page-controls">
                        <button class="pagination-btn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="pagination-btn active">1</button>
                        <button class="pagination-btn">2</button>
                        <button class="pagination-btn">3</button>
                        <span class="pagination-ellipsis">...</span>
                        <button class="pagination-btn">60</button>
                        <button class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- No Results Message (hidden by default) -->
            <div id="noResultsMessage" class="no-results" style="display: none;">
                <i class="fas fa-search fa-3x"></i>
                <h3>No invoices found</h3>
                <p>Try adjusting your search or filter criteria</p>
                <a href="#" id="resetFiltersLink">Reset all filters</a>
            </div>
        </div>
    </div>
    
    <!-- Create Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <!-- Stepper/Progress Bar -->
            <div class="modal-stepper">
                <div class="step-indicator active" data-step="1">1. Client Info</div>
                <div class="step-indicator" data-step="2">2. Invoice Details</div>
                <div class="step-indicator" data-step="3">3. Items</div>
                <div class="step-indicator" data-step="4">4. Review</div>
            </div>
            <div class="modal-header">
                <h2 data-translate="create_new_invoice_modal_title">Create New Invoice</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <!-- Step 1: Client Information -->
                    <div class="step step-1">
                        <h3 data-translate="client_information">Client Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="client-list" data-translate="client_name_company">Client Name/Company</label>
                                <div class="client-input-wrapper">
                                    <input type="text" id="client-list" placeholder="Type client name..." autocomplete="off" list="client-options" data-translate-placeholder="type_client_name_placeholder">
                                    <datalist id="client-options"></datalist>
                                    <button type="button" id="add-client-btn" class="btn secondary-btn" style="display:none;">
                                        <i class="fas fa-plus"></i> <span data-translate="new_client">New Client</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientEmail" data-translate="email">Email</label>
                                <input type="email" id="clientEmail" placeholder="client@example.com" readonly data-translate-placeholder="client_email_placeholder">
                            </div>
                            <div class="form-group">
                                <label for="clientTaxId" data-translate="tax_id_nuit">Tax ID (NUIT)</label>
                                <input type="text" id="clientTaxId" placeholder="e.g. 123456789" readonly data-translate-placeholder="tax_id_placeholder">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientAddress" data-translate="address">Address</label>
                                <textarea id="clientAddress" rows="3" placeholder="Client's full address" readonly data-translate-placeholder="client_address_placeholder"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer step-footer">
                            <button type="button" class="btn primary-btn next-step">Next</button>
                        </div>
                    </div>
                    <!-- Step 2: Invoice Details -->
                    <div class="step step-2" style="display:none;">
                        <h3 data-translate="invoice_details">Invoice Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoiceNumber" data-translate="invoice_number">Invoice Number</label>
                                <input type="text" id="invoiceNumber" value="Generating invoice number" readonly>
                            </div>
                            <div class="form-group">
                                <label for="issueDate" data-translate="issue_date">Issue Date</label>
                                <input type="date" id="issueDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dueDate" data-translate="due_date">Due Date</label>
                                <input type="date" id="dueDate" required>
                            </div>
                            <div class="form-group">
                                <label for="currency" data-translate="currency">Currency</label>
                                <select id="currency" required>
                                    <option value="MZN" selected>MZN - Mozambican Metical (MZN)</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - British Pound</option>
                                </select>
                                <div id="exchangeRateInfo" style="margin-top: 4px; font-size: 0.95em; color: #555;"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paymentTerms" data-translate="payment_terms">Payment Terms</label>
                                <select id="paymentTerms" required>
                                    <option value="net30" selected data-translate="net_30">Net 30 - Due in 30 days</option>
                                    <option value="net15" data-translate="net_15">Net 15 - Due in 15 days</option>
                                    <option value="net60" data-translate="net_60">Net 60 - Due in 60 days</option>
                                    <option value="custom" data-translate="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer step-footer">
                            <button type="button" class="btn secondary-btn prev-step">Back</button>
                            <button type="button" class="btn primary-btn next-step">Next</button>
                        </div>
                    </div>
                    <!-- Step 3: Items -->
                    <div class="step step-3" style="display:none;">
                        <h3 data-translate="items">Items</h3>
                        <div class="items-table-container">
                            <table id="itemsTable" class="items-table">
                                <thead>
                                    <tr>
                                        <th width="40%" data-translate="description">Description</th>
                                        <th width="15%" data-translate="quantity">Quantity</th>
                                        <th width="15%" data-translate="unit_price">Unit Price</th>
                                        <th width="10%" data-translate="vat_16">VAT (16%)</th>
                                        <th width="15%" data-translate="total">Total</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="item-row">
                                        <td>
                                            <div class="item-description-wrapper">
                                                <input type="text" class="item-description" placeholder="Enter item description" data-translate-placeholder="item_description_placeholder">
                                                <div class="product-suggestions" style="display: none;"></div>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="number" class="item-quantity" value="1" min="1" step="1">
                                        </td>
                                        <td>
                                            <input type="number" class="item-price" value="0.00" min="0" step="0.01">
                                        </td>
                                        <td>
                                            <span class="item-vat">0.00</span>
                                        </td>
                                        <td>
                                            <span class="item-total">0.00</span>
                                        </td>
                                        <td>
                                            <button type="button" class="remove-item-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button type="button" id="addItemBtn" class="btn secondary-btn">
                            <i class="fas fa-plus"></i> <span data-translate="add_item">Add Item</span>
                        </button>
                        <div class="invoice-totals">
                            <div class="totals-row">
                                <span data-translate="subtotal">Subtotal:</span>
                                <span id="subtotal">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span data-translate="vat_16_total">VAT (16%):</span>
                                <span id="totalVat">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span data-translate="total">Total:</span>
                                <span id="invoiceTotal">0.00</span>
                            </div>
                        </div>
                        <div class="modal-footer step-footer">
                            <button type="button" class="btn secondary-btn prev-step">Back</button>
                            <button type="button" class="btn primary-btn next-step">Next</button>
                        </div>
                    </div>
                    <!-- Step 4: Notes & Review -->
                    <div class="step step-4" style="display:none;">
                        <h3 data-translate="notes_terms">Notes & Terms</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="notes" data-translate="additional_notes">Additional Notes</label>
                                <textarea id="notes" rows="3" placeholder="Add any additional notes or terms..." data-translate-placeholder="additional_notes_placeholder"></textarea>
                            </div>
                        </div>
                        <h3>Review & Confirm</h3>
                        <div class="review-section">
                            <!-- Summary will be dynamically filled by JS -->
                            <div id="invoiceReviewSummary"></div>
                        </div>
                        <div class="invoice-totals">
                            <div class="totals-row">
                                <span data-translate="subtotal">Subtotal:</span>
                                <span id="reviewSubtotal">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span data-translate="vat_16_total">VAT (16%):</span>
                                <span id="reviewTotalVat">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span data-translate="total">Total:</span>
                                <span id="reviewInvoiceTotal">0.00</span>
                            </div>
                        </div>
                        <div class="modal-footer step-footer">
                            <button type="button" class="btn secondary-btn prev-step">Back</button>
                            <button type="submit" class="btn primary-btn">
                                <i class="fas fa-check"></i> <span data-translate="publish_invoice">Publish Invoice</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="invoice_details_title">Invoice Details</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invoice-view-header">
                    <div class="invoice-view-info">
                        <h3 id="viewInvoiceNumber">INV-2025-0001</h3>
                        <span id="viewInvoiceStatus" class="status paid">Paid</span>
                    </div>
                    <div class="invoice-view-actions">
                        <button class="btn secondary-btn" id="downloadPdfBtn">
                            <i class="fas fa-download"></i> <span data-translate="download_pdf">Download PDF</span>
                        </button>
                        <button class="btn primary-btn" id="sendInvoiceBtn">
                            <i class="fas fa-paper-plane"></i> <span data-translate="send">Send</span>
                        </button>
                    </div>
                </div>
                
                <div class="invoice-preview-container">
                    <div id="invoicePreviewContent">
                        <!-- Invoice content will be inserted here -->
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn primary-btn" id="closeInvoiceBtn">
                        <i class="fas fa-times"></i> <span data-translate="close">Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Email Invoice Modal -->
    <div id="emailInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Invoice</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="emailInvoiceForm">
                    <div class="form-group">
                        <label for="emailTo">To:</label>
                        <input type="email" id="emailTo" required>
                    </div>
                    <div class="form-group">
                        <label for="emailSubject">Subject:</label>
                        <input type="text" id="emailSubject" required>
                    </div>
                    <div class="form-group">
                        <label for="emailMessage">Message:</label>
                        <textarea id="emailMessage" rows="6" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="emailAttachPdf" checked>
                            Attach invoice as PDF
                        </label>
                    </div>
                    <div class="loading-indicator" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Sending email...
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn secondary-btn close-email-modal">
                    Cancel
                </button>
                <button type="submit" form="emailInvoiceForm" class="btn primary-btn">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <!-- Dark Mode Overlay (used when modal is open) -->
    <div class="modal-overlay"></div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="scripts/templateManager.js"></script>
    <script src="js/topbar-menu.js"></script>
    <script src="js/invoicescripts/notifications.js"></script>
    <!-- Core invoice modules -->
    <script src="js/invoicescripts/modalManager.js"></script>
    <script src="js/invoicescripts/invoiceTable.js"></script>
    <script src="js/invoicescripts/invoiceStatus.js"></script>
    <script src="js/invoicescripts/invoicePreview.js"></script>
    <script src="js/invoicescripts/invoiceItems.js"></script>
    <script src="js/invoicescripts/metrics.js"></script>
    <script src="js/invoicescripts/charts.js"></script>
    <script src="js/invoicescripts/eventListeners.js"></script>
    <script src="js/invoicescripts/invoiceActions.js"></script>
    <script src="js/invoicescripts/pdf.js"></script>
    <script src="js/email-handler.js"></script>
    <script src="js/invoice.js"></script>
    <script src="js/displayname.js"></script>
    <script src="js/walaka-assistant.js"></script>
    <script src="js/hints/page-hints.js"></script>
    <script src="js/hints/walaka-hints.js"></script>
    <script src="js/auth.js"></script>
    <!-- Notification badge synchronization -->
    <script src="js/notification-badge.js"></script>

    <!-- Initialize Supabase -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm';
        
        // Create single Supabase instance
        const supabase = createClient(
            'https://qvmtozjvjflygbkjecyj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2bXRvemp2amZseWdia2plY3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjc2MjMsImV4cCI6MjA2MTcwMzYyM30.DJMC1eM5_EouM1oc07JaoXsMX_bSLn2AVCozAcdfHmo',
            {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                }
            }
        );

        // Check for existing session
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            console.warn('No active session found. Some features may be limited.');
        }

        window.supabase = supabase;

        // Clients functionality
        let clients = [];

        async function fetchClients() {
            try {
                const { data, error } = await supabase.from('clients').select('*');
                if (error) throw error;
                
                clients = data;
                updateClientDatalist();
                console.log('Clients loaded successfully:', clients.length);
            } catch (error) {
                console.error('Error fetching clients:', error);
                showNotification('Error loading clients: ' + error.message);
            }
        }

        function updateClientDatalist() {
            const datalist = document.getElementById('client-options');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.customer_name;
                option.dataset.clientId = client.id;
                datalist.appendChild(option);
            });
        }

        function setupClientHandlers() {
            const clientInput = document.getElementById('client-list');
            const addClientBtn = document.getElementById('add-client-btn');
            const newClientModal = document.getElementById('newClientModal');
            const saveNewClientBtn = document.getElementById('save-new-client');
            const closeModalBtns = document.querySelectorAll('#newClientModal .close-modal');

            if (clientInput) {
                clientInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    const exists = clients.some(c => c.customer_name === value);
                    if (addClientBtn) {
                        addClientBtn.style.display = (!exists && value) ? 'inline-block' : 'none';
                    }
                });

                clientInput.addEventListener('change', function() {
                    const selectedClient = clients.find(c => c.customer_name === this.value);
                    if (selectedClient) {
                        populateClientFields(selectedClient);
                    }
                });
            }

            if (addClientBtn) {
                addClientBtn.addEventListener('click', function() {
                    if (newClientModal) {
                        const clientNameInput = document.getElementById('new-client-name');
                        if (clientNameInput) {
                            clientNameInput.value = document.getElementById('client-list').value;
                        }
                        openModal('newClientModal');
                    }
                });
            }

            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal('newClientModal');
                });
            });

            if (saveNewClientBtn) {
                saveNewClientBtn.addEventListener('click', async function() {
                    try {
                        const name = document.getElementById('new-client-name').value;
                        const nuit = document.getElementById('new-client-nuit').value;
                        const email = document.getElementById('new-client-email').value;
                        const address = document.getElementById('new-client-address').value;

                        if (!name) {
                            throw new Error('Client name is required');
                        }

                        const { data, error } = await supabase
                            .from('clients')
                            .insert([{ 
                                customer_name: name,
                                nuit: nuit,
                                email: email,
                                address: address
                            }])
                            .select();

                        if (error) throw error;

                        clients.push(data[0]);
                        updateClientDatalist();
                        
                        if (clientInput) clientInput.value = name;
                        populateClientFields(data[0]);
                        closeModal('newClientModal');
                        
                        showNotification('Client added successfully');
                    } catch (error) {
                        console.error('Error adding client:', error);
                        showNotification('Error adding client: ' + error.message);
                    }
                });
            }
        }

        function populateClientFields(client) {
            if (!client) return;
            
            const emailInput = document.getElementById('clientEmail');
            const taxIdInput = document.getElementById('clientTaxId');
            const addressInput = document.getElementById('clientAddress');

            if (emailInput) emailInput.value = client.email || '';
            if (taxIdInput) taxIdInput.value = client.customer_tax_id || '';
            
            // Build full address from components
            const addressParts = [
                client.building_number,
                client.street_name,
                client.address_detail,
                client.city,
                client.province,
                client.postal_code,
                client.country
            ].filter(Boolean);
            
            if (addressInput) addressInput.value = addressParts.join(', ');
        }

        // Products functionality
        let cachedProducts = [];

        async function fetchProducts() {
            try {
                console.log("Fetching products...");
                const { data, error } = await supabase.from('products').select('*');

                if (error) throw error;

                cachedProducts = data;
                console.log("Products loaded:", cachedProducts.length);
            } catch (error) {
                console.error('Error fetching products:', error);
                showNotification('Error loading products: ' + error.message);
            }
        }

        // Invoices functionality
        let cachedInvoices = [];

        async function fetchInvoices() {
            try {
                const { data, error } = await supabase.from('invoices').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                cachedInvoices = data;
                console.log('Invoices loaded (RLS enforced):', cachedInvoices.length);
            } catch (error) {
                console.error('Error fetching invoices:', error);
                showNotification('Error loading invoices: ' + error.message);
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Wait for window.supabase to be initialized by the module script
                while (!window.supabase || !window.supabase.auth) {
                    console.log('Waiting for Supabase client initialization...');
                    await new Promise(resolve => setTimeout(resolve, 100)); // Wait 100ms
                }
                console.log('Supabase client initialized!', window.supabase);

                // Initialize invoice actions - Pass the initialized supabase client
                if (window.InvoiceActions && window.supabase) {
                    window.invoiceActions = new window.InvoiceActions(window.supabase);
                    console.log('Invoice actions initialized successfully');
                } else {
                    console.error('InvoiceActions class or Supabase client not found during actions initialization');
                }            // Initialize invoice table module first
            if (window.invoiceTable) {
                window.invoiceTable.init();
                console.log('Invoice table module initialized successfully');
            } else {
                console.error('invoiceTable not found');
                return;
            }

            // Initialize date range filter module
            if (window.DateRangeFilterModule) {
                window.DateRangeFilterModule.init();
                console.log('Date range filter initialized successfully');
            } else {
                console.error('DateRangeFilterModule not found');
            }

            // Initialize table filters
            if (typeof window.setupTableFilters === 'function') {
                window.setupTableFilters();
                console.log('Table filters initialized successfully');
            } else {
                console.error('Table filters setup function not found');
            }

                // Initialize invoice table
                if (window.invoiceTable && typeof window.invoiceTable.fetchAndDisplayInvoices === 'function') {
                    await window.invoiceTable.fetchAndDisplayInvoices(1, 10, {});
                    console.log('Invoice table initialized successfully');
                } else {
                    console.error('Invoice table functions not found');
                }

                // Initialize invoice items
                if (window.InvoiceItems) {
                    window.invoiceItems = new window.InvoiceItems();
                    console.log('Invoice items initialized successfully');
                } else {
                    console.error('InvoiceItems class not found');
                }

                // Initialize charts
                if (typeof window.setupCharts === 'function') {
                    window.setupCharts();
                    window.setupChartPeriodControls();
                    console.log('Charts initialized successfully');
                } else {
                    console.error('Chart setup functions not found');
                }

                // Initialize metrics
                if (typeof window.updateMetricsDisplay === 'function') {
                    await window.updateMetricsDisplay();
                    window.setupMetricsSubscription();
                    console.log('Metrics initialized successfully');
                } else {
                    console.error('Metrics functions not found');
                }

                // Update charts with data
                if (typeof window.updateCharts === 'function') {
                    await window.updateCharts();
                    window.setupChartSubscription();
                    console.log('Charts updated successfully');
                } else {
                    console.error('Chart update functions not found');
                }

                // Setup client handlers
                setupClientHandlers();

                // Fetch initial data
                await fetchClients();
                await fetchProducts();
                await fetchInvoices(); // Fetch invoices

            } catch (error) {
                console.error('Error during initialization:', error);
                showNotification('Error initializing application: ' + error.message);
            }
        });
    </script>
<!--
     Date Range Modal 
    <div id="dateRangeModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Date Range</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="applyDateRange">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <style>
    #dateRangeModal .modal-body {
        padding: 20px;
    }

    #dateRangeModal .form-group {
        margin-bottom: 15px;
    }

    #dateRangeModal label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    #dateRangeModal input[type="date"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    </style>
-->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date range modal
        const dateRangeFilter = document.getElementById('dateRangeFilter');
        const dateRangeModal = $('#dateRangeModal');
        
        if (dateRangeFilter && dateRangeModal.length) {
            dateRangeFilter.addEventListener('change', function() {
                if (this.value === 'custom') {
                    dateRangeModal.modal('show');
                } else {
                    // Apply preset filter when a non-custom option is selected
                     if (window.invoiceTable && typeof window.invoiceTable.applyFilters === 'function') {
                        window.invoiceTable.currentFilters.dateRange = this.value;
                        window.invoiceTable.currentFilters.customDateRange = null;
                        window.invoiceTable.applyFilters();
                    } else {
                        console.error('invoiceTable or applyFilters not found');
                    }
                }
            });
        }

        // Set default dates in modal
        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        if (startDateInput) startDateInput.value = lastMonth.toISOString().split('T')[0];
        if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];

        // Handle date range application
        const applyDateRangeBtn = document.getElementById('applyDateRange');
        if (applyDateRangeBtn && startDateInput && endDateInput) {
            applyDateRangeBtn.addEventListener('click', function() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (!startDate || !endDate) {
                    showNotification('Please select both start and end dates', 'error');
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    showNotification('Start date cannot be after end date', 'error');
                    return;
                }

                // Update the table with the custom date range
                if (window.invoiceTable && typeof window.invoiceTable.applyFilters === 'function') {
                     if (dateRangeFilter) dateRangeFilter.value = 'custom';
                    window.invoiceTable.currentFilters.dateRange = 'custom';
                    window.invoiceTable.currentFilters.customDateRange = {
                        startDate: startDate,
                        endDate: endDate
                    };
                    window.invoiceTable.applyFilters();
                } else {
                    console.error('invoiceTable or applyFilters not found');
                }
                dateRangeModal.modal('hide');
            });
        }

        // Handle export button clicks
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportSaftBtn = document.getElementById('exportSaftBtn');
        const exportPeriodFilter = document.getElementById('dateRangeFilter'); 

        if (exportCsvBtn && typeof window.exportInvoicesAsCsv === 'function' && exportPeriodFilter) {
            exportCsvBtn.addEventListener('click', function() {
                const period = exportPeriodFilter.value;
                if (period === 'custom') {
                    const startDate = startDateInput ? startDateInput.value : null;
                    const endDate = endDateInput ? endDateInput.value : null;
                    if (!startDate || !endDate) {
                         showNotification('Please select custom dates for export first', 'error');
                         return;
                    }
                    window.exportInvoicesAsCsv({ period: 'custom', startDate: startDate, endDate: endDate });
                } else {
                    window.exportInvoicesAsCsv(period);
                }
            });
        }

        if (exportSaftBtn && typeof window.exportInvoicesAsSaft === 'function' && exportPeriodFilter) {
            exportSaftBtn.addEventListener('click', function() {
                const period = exportPeriodFilter.value;
                 if (period === 'custom') {
                    const startDate = startDateInput ? startDateInput.value : null;
                    const endDate = endDateInput ? endDateInput.value : null;
                    if (!startDate || !endDate) {
                         showNotification('Please select custom dates for export first', 'error');
                         return;
                    }
                    window.exportInvoicesAsSaft({ period: 'custom', startDate: startDate, endDate: endDate });
                } else {
                    window.exportInvoicesAsSaft(period);
                }
            });
        }
    });
    </script>
    <script src="components/sidebar-actions.js"></script>
    <script>
    // Add this before other invoice scripts
    window.lastSavedInvoice = null;
    </script>
    <script src="services/languageManager.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async function() {
        const languageManager = new LanguageManager('./');
        window.languageManager = languageManager; // Make it globally available
        await languageManager.initialize();
      });
    </script>
    <script>
    // Register hints for key UI elements in Invoice Management
    // Ensure this runs after walaka-hints.js and DOMContentLoaded

    document.addEventListener('DOMContentLoaded', function() {
      // Wait for walakaHints to be initialized
      function registerHints() {
        if (!window.walakaHints) {
          setTimeout(registerHints, 100);
          return;
        }
        // Create Invoice button
        window.walakaHints.addHint(
          'createInvoiceBtn',
          'Create Invoice',
          'Click here to start creating a new invoice. You will be able to add client details, items, and set payment terms.'
        );
        // Status filter
        window.walakaHints.addHint(
          'statusFilter',
          'Status Filter',
          'Filter invoices by their payment status: Paid, Pending, Overdue, or Draft.'
        );
        // Client filter
        window.walakaHints.addHint(
          'clientFilter',
          'Client Filter',
          'Show invoices for a specific client or view all clients.'
        );
        // Date range filter
        window.walakaHints.addHint(
          'dateRangeFilter',
          'Date Range Filter',
          'Filter invoices by date. Choose a preset period or select a custom date range.'
        );
        // Search bar
        window.walakaHints.addHint(
          'searchInvoices',
          'Search Invoices',
          'Quickly find invoices by number, client name, or other keywords.'
        );
        // Export CSV button
        window.walakaHints.addHint(
          'exportCsvBtn',
          'Export as CSV',
          'Download the current list of invoices as a CSV file for use in Excel or other tools.'
        );
        // Export SAFT button
        window.walakaHints.addHint(
          'exportSaftBtn',
          'Export as SAFT',
          'Export invoices in SAFT format for tax and compliance reporting.'
        );
        // Add Item button in modal
        window.walakaHints.addHint(
          'addItemBtn',
          'Add Item',
          'Add a new product or service line to this invoice.'
        );
        // Invoice Total
        window.walakaHints.addHint(
          'invoiceTotal',
          'Invoice Total',
          'This is the total amount for the invoice, including VAT.'
        );
        // Preview Invoice button
        window.walakaHints.addHint(
          'previewInvoiceBtn',
          'Preview Invoice',
          'See a preview of the invoice before publishing or sending it to the client.'
        );
      }
      registerHints();
    });
    </script>

<!-- Quick Add Client Modal -->
<div id="quickAddClientModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 data-translate="quick_add_client">Quick Add Client</h3>
            <button type="button" class="close-modal" id="closeQuickAddModal" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="quickClientForm">
                <div class="form-group">
                    <label data-translate="client_type">Client Type</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="quick-client-type" value="business" checked>
                            <span data-translate="business">Business</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="quick-client-type" value="individual">
                            <span data-translate="individual">Individual</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="quick-company-name" data-translate="company_name_label">Company Name <span class="required">*</span></label>
                    <input type="text" id="quick-company-name" name="company_name" required data-translate-placeholder="company_name_placeholder" placeholder="Company Name">
                </div>
                <div class="form-group">
                    <label for="quick-customer-tax-id" data-translate="tax_id_nuit">NIF/NUIT <span class="required">*</span></label>
                    <input type="text" id="quick-customer-tax-id" name="customer_tax_id" required data-translate-placeholder="tax_id_placeholder" placeholder="NIF/NUIT" maxlength="9">
                </div>
                <div class="form-group">
                    <label for="quick-contact" data-translate="contact">Contact <span class="required">*</span></label>
                    <input type="text" id="quick-contact" name="contact" required data-translate-placeholder="contact_placeholder" placeholder="Contact">
                </div>
                <div class="form-group">
                    <label for="quick-billing-address" data-translate="billing_address">Billing Address <span class="required">*</span></label>
                    <input type="text" id="quick-billing-address" name="billing_address" required data-translate-placeholder="billing_address_placeholder" placeholder="Billing Address">
                </div>
                <div class="form-group">
                    <label for="quick-street-name" data-translate="street_name">Street <span class="required">*</span></label>
                    <input type="text" id="quick-street-name" name="street_name" required data-translate-placeholder="street_name_placeholder" placeholder="Street">
                </div>
                <div class="form-group">
                    <label for="quick-city" data-translate="city">City <span class="required">*</span></label>
                    <input type="text" id="quick-city" name="city" required data-translate-placeholder="city_placeholder" placeholder="City">
                </div>
                <div class="form-group">
                    <label for="quick-province" data-translate="province">Province <span class="required">*</span></label>
                    <input type="text" id="quick-province" name="province" required data-translate-placeholder="province_placeholder" placeholder="Province">
                </div>
                <div class="form-group">
                    <label for="quick-country" data-translate="country">Country <span class="required">*</span></label>
                    <input type="text" id="quick-country" name="country" required data-translate-placeholder="country_placeholder" placeholder="Country">
                </div>
                <div class="form-group">
                    <label for="quick-telephone" data-translate="telephone">Telephone <span class="required">*</span></label>
                    <input type="text" id="quick-telephone" name="telephone" required data-translate-placeholder="telephone_placeholder" placeholder="Telephone">
                </div>
                <div class="form-group">
                    <label for="quick-email" data-translate="email">Email <span class="required">*</span></label>
                    <input type="email" id="quick-email" name="email" required data-translate-placeholder="email_placeholder" placeholder="Email">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="saveQuickClientBtn" class="primary-btn" data-translate="save_client">Save Client</button>
            <button type="button" id="cancelQuickClientBtn" class="secondary-btn" data-translate="cancel">Cancel</button>
        </div>
    </div>
</div>

<!-- Success Message Modal -->
<div id="clientSuccessModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 data-translate="client_created_successfully">Client Created Successfully</h3>
            <button type="button" class="close-modal" id="closeSuccessModal" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <p data-translate="client_created_message">The client has been created and is now available for selection in the invoice form.</p>
            </div>
            <div class="client-info-preview">
                <h4 data-translate="client_information">Client Information</h4>
                <div id="clientInfoPreview"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="useClientBtn" class="primary-btn" data-translate="use_this_client">Use This Client</button>
            <button type="button" id="closeSuccessBtn" class="secondary-btn" data-translate="close">Close</button>
        </div>
    </div>
</div>

<script>
// Quick Add Client Modal Logic
let newlyCreatedClient = null;

function showQuickAddClientModal() {
    const modal = document.getElementById('quickAddClientModal');
    modal.style.display = 'block';
    document.getElementById('quickClientForm').reset();
    document.querySelector('input[name="quick-client-type"][value="business"]').checked = true;
}

function hideQuickAddClientModal() {
    const modal = document.getElementById('quickAddClientModal');
    modal.style.display = 'none';
}

function showClientSuccessModal(clientData) {
    const modal = document.getElementById('clientSuccessModal');
    const previewDiv = document.getElementById('clientInfoPreview');
    previewDiv.innerHTML = `
        <div class="client-info-grid">
            <div><strong>Name:</strong> ${clientData.customer_name}</div>
            <div><strong>Tax ID:</strong> ${clientData.customer_tax_id}</div>
            <div><strong>Contact:</strong> ${clientData.contact}</div>
            <div><strong>Email:</strong> ${clientData.email}</div>
            <div><strong>Phone:</strong> ${clientData.telephone}</div>
            <div><strong>Address:</strong> ${clientData.billing_address}, ${clientData.city}, ${clientData.province}</div>
        </div>
    `;
    modal.style.display = 'block';
}

function hideClientSuccessModal() {
    const modal = document.getElementById('clientSuccessModal');
    modal.style.display = 'none';
}

async function saveQuickClient() {
    const form = document.getElementById('quickClientForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    try {
        const formData = {
            customer_name: document.getElementById('quick-company-name').value,
            customer_tax_id: document.getElementById('quick-customer-tax-id').value,
            contact: document.getElementById('quick-contact').value,
            billing_address: document.getElementById('quick-billing-address').value,
            street_name: document.getElementById('quick-street-name').value,
            city: document.getElementById('quick-city').value,
            province: document.getElementById('quick-province').value,
            country: document.getElementById('quick-country').value,
            telephone: document.getElementById('quick-telephone').value,
            email: document.getElementById('quick-email').value,
            status: 'active',
            client_type: document.querySelector('input[name="quick-client-type"]:checked').value,
            user_id: (await window.supabase.auth.getUser()).data.user?.id
        };
        if (formData.telephone) {
            formData.telephone = parseInt(formData.telephone.replace(/\D/g, '')) || null;
        }
        const { data, error } = await window.supabase
            .from('clients')
            .insert([formData])
            .select();
        if (error) throw error;
        newlyCreatedClient = data[0];
        hideQuickAddClientModal();
        showClientSuccessModal(newlyCreatedClient);
        if (typeof window.fetchClients === 'function') {
            await window.fetchClients();
        }
        const clientInput = document.getElementById('client-list');
        if (clientInput && newlyCreatedClient) {
            clientInput.value = newlyCreatedClient.customer_name;
            clientInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    } catch (error) {
        alert('Error saving client: ' + error.message);
    }
}

function useNewlyCreatedClient() {
    if (newlyCreatedClient) {
        hideClientSuccessModal();
        const clientInput = document.getElementById('client-list');
        if (clientInput) {
            clientInput.value = newlyCreatedClient.customer_name;
            clientInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
}

window.addEventListener('DOMContentLoaded', function() {
    // Button triggers
    const addClientBtn = document.getElementById('add-client-btn');
    const closeQuickAddModal = document.getElementById('closeQuickAddModal');
    const cancelQuickClientBtn = document.getElementById('cancelQuickClientBtn');
    const saveQuickClientBtn = document.getElementById('saveQuickClientBtn');
    const closeSuccessModal = document.getElementById('closeSuccessModal');
    const closeSuccessBtn = document.getElementById('closeSuccessBtn');
    const useClientBtn = document.getElementById('useClientBtn');
    if (addClientBtn) addClientBtn.addEventListener('click', showQuickAddClientModal);
    if (closeQuickAddModal) closeQuickAddModal.addEventListener('click', hideQuickAddClientModal);
    if (cancelQuickClientBtn) cancelQuickClientBtn.addEventListener('click', hideQuickAddClientModal);
    if (saveQuickClientBtn) saveQuickClientBtn.addEventListener('click', saveQuickClient);
    if (closeSuccessModal) closeSuccessModal.addEventListener('click', hideClientSuccessModal);
    if (closeSuccessBtn) closeSuccessBtn.addEventListener('click', hideClientSuccessModal);
    if (useClientBtn) useClientBtn.addEventListener('click', useNewlyCreatedClient);
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
        const quickAddModal = document.getElementById('quickAddClientModal');
        const successModal = document.getElementById('clientSuccessModal');
        if (event.target === quickAddModal) hideQuickAddClientModal();
        if (event.target === successModal) hideClientSuccessModal();
    });
});
</script>

<!-- 1. Add "+ Add Product" button to the items section of the invoice modal -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add the button after the Add Item button in the invoice modal
    const addItemBtn = document.getElementById('addItemBtn');
    if (addItemBtn && !document.getElementById('addProductBtn')) {
        const addProductBtn = document.createElement('button');
        addProductBtn.type = 'button';
        addProductBtn.id = 'addProductBtn';
        addProductBtn.className = 'btn secondary-btn';
        addProductBtn.innerHTML = '<i class="fas fa-plus"></i> <span>Add Product</span>';
        addItemBtn.parentNode.insertBefore(addProductBtn, addItemBtn.nextSibling);
        addProductBtn.addEventListener('click', showQuickAddProductModal);
    }
});
</script>

<!-- 2. Add Quick Add Product Modal HTML -->
<div id="quickAddProductModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Quick Add Product</h3>
            <button type="button" class="close-modal" id="closeQuickAddProductModal" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="quickProductForm">
                <div class="form-group">
                    <label for="quick-product-description">Description <span class="required">*</span></label>
                    <input type="text" id="quick-product-description" name="description" required placeholder="Enter product description">
                </div>
                <div class="form-group">
                    <label for="quick-product-price">Price <span class="required">*</span></label>
                    <input type="number" id="quick-product-price" name="price" step="0.01" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="quick-product-tax-code">Tax Code (SAT) <span class="required">*</span></label>
                    <input type="text" id="quick-product-tax-code" name="tax_code" required placeholder="e.g. 10101">
                </div>
                <div class="form-group">
                    <label for="quick-product-vat">VAT Rate <span class="required">*</span></label>
                    <select id="quick-product-vat" name="tax_rate" required>
                        <option value="">Select VAT rate</option>
                        <option value="0">0%</option>
                        <option value="0.16">16%</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div id="quick-product-other-vat-container" class="form-group" style="display: none;">
                    <label for="quick-product-other-vat">Custom VAT Rate (%)</label>
                    <input type="number" id="quick-product-other-vat" min="0" max="100" step="1">
                </div>
                <div class="form-group">
                    <label for="quick-product-industry">Industry <span class="required">*</span></label>
                    <select id="quick-product-industry" name="industry" required>
                        <option value="">Loading industries...</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="saveQuickProductBtn" class="primary-btn">Save Product</button>
            <button type="button" id="cancelQuickProductBtn" class="secondary-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Success Message Modal for Product -->
<div id="productSuccessModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Product Created Successfully</h3>
            <button type="button" class="close-modal" id="closeProductSuccessModal" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <p>The product has been created and is now available for selection in the invoice form.</p>
            </div>
            <div class="client-info-preview">
                <h4>Product Information</h4>
                <div id="productInfoPreview"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="useProductBtn" class="primary-btn">Use This Product</button>
            <button type="button" id="closeProductSuccessBtn" class="secondary-btn">Close</button>
        </div>
    </div>
</div>

<!-- 3. Add Quick Add Product Modal Logic -->
<script>
let newlyCreatedProduct = null;

async function fetchAndPopulateQuickProductIndustries() {
    const quickIndustrySelect = document.getElementById('quick-product-industry');
    if (!quickIndustrySelect || !window.supabase) return;
    try {
        quickIndustrySelect.innerHTML = '<option value="">Loading industries...</option>';
        const { data, error } = await window.supabase
            .from('cae')
            .select('Subclasse, Descricao')
            .order('Descricao', { ascending: true });
        if (error) throw error;
        if (!data || data.length === 0) {
            quickIndustrySelect.innerHTML = '<option value="">No industries found</option>';
            return;
        }
        const validIndustries = data.filter(row => row.Subclasse && /^\d+$/.test(row.Subclasse) && row.Descricao && row.Descricao.trim() !== '');
        validIndustries.sort((a, b) => Number(a.Subclasse) - Number(b.Subclasse));
        quickIndustrySelect.innerHTML = '<option value="">Select industry</option>' +
            validIndustries.map(row => `<option value="${row.Subclasse}">${row.Subclasse} - ${row.Descricao}</option>`).join('');
    } catch (err) {
        quickIndustrySelect.innerHTML = '<option value="">Failed to load industries</option>';
        console.error('Error loading industries:', err);
    }
}

function showQuickAddProductModal() {
    const modal = document.getElementById('quickAddProductModal');
    modal.style.display = 'block';
    document.getElementById('quickProductForm').reset();
    document.getElementById('quick-product-vat').value = '';
    document.getElementById('quick-product-other-vat-container').style.display = 'none';
    fetchAndPopulateQuickProductIndustries();
}

function hideQuickAddProductModal() {
    const modal = document.getElementById('quickAddProductModal');
    modal.style.display = 'none';
}

function showProductSuccessModal(productData) {
    const modal = document.getElementById('productSuccessModal');
    const previewDiv = document.getElementById('productInfoPreview');
    previewDiv.innerHTML = `
        <div class="client-info-grid">
            <div><strong>Description:</strong> ${productData.description}</div>
            <div><strong>Price:</strong> ${productData.price}</div>
            <div><strong>Tax Code:</strong> ${productData.tax_code}</div>
            <div><strong>VAT Rate:</strong> ${(productData.tax_rate * 100).toFixed(2)}%</div>
            <div><strong>Industry:</strong> ${productData.industry}</div>
        </div>
    `;
    modal.style.display = 'block';
}

function hideProductSuccessModal() {
    const modal = document.getElementById('productSuccessModal');
    modal.style.display = 'none';
}

document.getElementById('quick-product-vat').addEventListener('change', function() {
    const otherContainer = document.getElementById('quick-product-other-vat-container');
    if (this.value === 'other') {
        otherContainer.style.display = 'block';
    } else {
        otherContainer.style.display = 'none';
    }
});

document.getElementById('saveQuickProductBtn').addEventListener('click', async function() {
    const form = document.getElementById('quickProductForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    try {
        const { data: { session } } = await window.supabase.auth.getSession();
        if (!session?.user) {
            alert('Please login to continue');
            return;
        }
        const formData = {
            description: document.getElementById('quick-product-description').value.trim(),
            price: parseFloat(document.getElementById('quick-product-price').value),
            tax_code: document.getElementById('quick-product-tax-code').value.trim(),
            industry: document.getElementById('quick-product-industry').value,
            tax_rate: document.getElementById('quick-product-vat').value === 'other'
                ? parseFloat(document.getElementById('quick-product-other-vat').value) / 100
                : parseFloat(document.getElementById('quick-product-vat').value),
            user_id: session.user.id
        };
        if (!formData.description || isNaN(formData.price) || !formData.tax_code || isNaN(formData.tax_rate) || !formData.industry) {
            alert('Please fill in all required fields correctly');
            return;
        }
        const { data, error } = await window.supabase
            .from('products')
            .insert([formData])
            .select();
        if (error) throw error;
        newlyCreatedProduct = data[0];
        hideQuickAddProductModal();
        showProductSuccessModal(newlyCreatedProduct);
        if (typeof window.fetchProducts === 'function') {
            await window.fetchProducts();
        }
        // Optionally, auto-select the new product in the invoice item row (if you have a product selector)
        // You may need to implement this depending on your invoice item row UI
    } catch (error) {
        alert('Error saving product: ' + error.message);
    }
});

document.getElementById('cancelQuickProductBtn').addEventListener('click', hideQuickAddProductModal);
document.getElementById('closeQuickAddProductModal').addEventListener('click', hideQuickAddProductModal);
document.getElementById('closeProductSuccessModal').addEventListener('click', hideProductSuccessModal);
document.getElementById('closeProductSuccessBtn').addEventListener('click', hideProductSuccessModal);
document.getElementById('useProductBtn').addEventListener('click', function() {
    if (newlyCreatedProduct) {
        hideProductSuccessModal();
        // Optionally, auto-fill the first empty item row in the invoice form with the new product
        // Example logic (adjust selectors as needed):
        const itemRows = document.querySelectorAll('#itemsTable tbody tr');
        for (const row of itemRows) {
            const descInput = row.querySelector('.item-description');
            const priceInput = row.querySelector('.item-price');
            const vatSpan = row.querySelector('.item-vat');
            if (descInput && priceInput && !descInput.value) {
                descInput.value = newlyCreatedProduct.description;
                priceInput.value = newlyCreatedProduct.price;
                if (vatSpan) vatSpan.textContent = (newlyCreatedProduct.tax_rate * 100).toFixed(2);
                // Optionally trigger change/input events if your invoice logic needs it
                descInput.dispatchEvent(new Event('input', { bubbles: true }));
                priceInput.dispatchEvent(new Event('input', { bubbles: true }));
                break;
            }
        }
    }
});
</script>