<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WALAKA - Invoice Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/invoice.css">
<!--    <link rel="stylesheet" href="css/invoice-print.css"> -->
    <link rel="stylesheet" href="css/invoice-layout.css">
    <link rel="stylesheet" href="css/hints.css">
<!-- 
    <style>
        .item-row td {
            position: relative;
        }
        
        .product-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .new-product-form {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            z-index: 1000;
        }

        .new-product-form .form-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .new-product-form .form-group {
            flex: 1;
        }

        .new-product-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .new-product-form input,
        .new-product-form select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .save-product-btn {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .save-product-btn:hover {
            background: var(--primary-color-dark);
        }
    </style>
-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar Menu -->
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>WALAKA</span>
            </div>
            
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="nav-section">
                    <h3 class="nav-header has-submenu">
                        Facturação
                    </h3>
                    <div class="submenu">
                        <div class="nav-section">
                            <h3 class="nav-header has-submenu">
                                Documents
                            </h3>
                            <div class="submenu">
                                <a href="invoices.html" class="nav-item active">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <span>Facturas</span>
                                </a>
                                <a href="credit_notes.html" class="nav-item">
                                    <i class="fas fa-file-invoice"></i>
                                    <span>Notas de Crédito</span>
                                </a>
                                <a href="debit_notes.html" class="nav-item">
                                    <i class="fas fa-file-invoice"></i>
                                    <span>Notas de Débito</span>
                                </a>
                                <a href="receipts.html" class="nav-item">
                                    <i class="fas fa-receipt"></i>
                                    <span>Recibos</span>
                                </a>
                            </div>
                        </div>
                        <a href="clients/clients.html" class="nav-item">
                            <i class="fas fa-users"></i>
                            <span>Clientes</span>
                        </a>
                        <a href="products.html" class="nav-item">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Produtos</span>
                        </a>
                    </div>
                </div>

                <!--
                <div class="nav-section">
                    <h3 class="nav-header has-submenu">
                        Comercial
                    </h3>
                    <div class="submenu">
                        <a href="#" class="nav-item">
                            <i class="fas fa-boxes"></i>
                            <span>Inventário</span>
                        </a>
                        <a href="#" class="nav-item">
                            <i class="fas fa-truck"></i>
                            <span>Fornecedores</span>
                        </a>
                        <a href="#" class="nav-item">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Movimentos</span>
                        </a>
                        <a href="#" class="nav-item">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Despesas</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <h3 class="nav-header has-submenu">
                        Contabilidade
                    </h3>
                    <div class="submenu">
                        <a href="#" class="nav-item">
                            <i class="fas fa-book"></i>
                            <span>Lançamentos</span>
                        </a>
                        <a href="#" class="nav-item">
                            <i class="fas fa-list-alt"></i>
                            <span>Plano de Contas</span>
                        </a>
                        <a href="#" class="nav-item">
                            <i class="fas fa-percent"></i>
                            <span>Impostos</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <h3 class="nav-header has-submenu">
                        Finanças
                    </h3>
                    <div class="submenu">
                        <a href="#" class="nav-item">
                            <i class="fas fa-chart-pie"></i>
                            <span>Relatórios</span>
                        </a>
                        <a href="#" class="nav-item">
                            <i class="fas fa-chart-line"></i>
                            <span>Indicadores-chave</span>
                        </a>
                    </div>
                </div>
                -->

                <div class="nav-section">
                    <h3 class="nav-header has-submenu">
                        Settings
                    </h3>
                    <div class="submenu">
                        <a href="settings.html" class="nav-item">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                        <a href="usermanagement-vanilla/index.html" class="nav-item">
                            <i class="fas fa-user-cog"></i>
                            <span>Gestão de Utilizadores</span>
                        </a>
                        <a href="#" class="nav-item">
                            <i class="fas fa-question-circle"></i>
                            <span>Ajuda</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                
                <div class="user-menu" style="margin-left:auto;">
                    <a href="notifications.html" class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </a>
                    
                    <div class="user-profile" id="userProfile">
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span id="user-displayname">Loading...</span>
                        <div class="dropdown-menu" id="userDropdown">
                            <a href="#">
                                <i class="fas fa-user-circle"></i> My Profile
                            </a>
                            <a href="settings.html">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                            <a href="#">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Dashboard Content -->
            <div class="page-header">
                <div>
                    <h2>Invoice Management</h2>
                    <p class="subtitle">Create, manage, and track all your invoices</p>
                </div>
                <div class="action-buttons">

                    <button class="btn primary-btn" id="createInvoiceBtn">
                        <i class="fas fa-plus"></i> Create Invoice
                    </button>
                </div>
            </div>
            
            <!-- Invoice Metrics -->
            <div class="metrics-grid">
                <div class="metric-card" id="totalInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-file-invoice"></i>
                        <span>Total Invoices</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label">All Time</span>
                    </div>
                </div>
                
                <div class="metric-card" id="paidInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-check-circle"></i>
                        <span>Paid Invoices</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label">0% of Total</span>
                    </div>
                </div>
                
                <div class="metric-card" id="pendingInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-clock"></i>
                        <span>Pending Payments</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label">0% of Total</span>
                    </div>
                </div>
                
                <div class="metric-card" id="overdueInvoicesCard">
                    <div class="metric-header">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Overdue Invoices</span>
                    </div>
                    <div class="metric-value">0</div>
                    <div class="metric-footer">
                        <span class="metric-label">0% of Total</span>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <h3>
                        Invoice Distribution
                        <div class="chart-actions">
                            <button id="weeklyBtn" class="chart-period-btn active">Weekly</button>
                            <button id="monthlyBtn" class="chart-period-btn">Monthly</button>
                            <button id="quarterlyBtn" class="chart-period-btn">Quarterly</button>
                        </div>
                    </h3>
                    <div class="chart-container">
                        <canvas id="invoiceDistributionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3>
                        Revenue by Status
                        <div class="chart-actions">
                            <button id="revenueMonthlyBtn" class="chart-period-btn active">Monthly</button>
                            <button id="revenueYearlyBtn" class="chart-period-btn">Yearly</button>
                        </div>
                    </h3>
                    <div class="chart-container">
                        <canvas id="revenueByStatusChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Table Filter Section -->
            <div class="invoice-table-container">
                <div class="table-header">
                    <h3>Recent Invoices</h3>
                    <div class="table-filters">
                        <div class="filter-group">
                            <label for="statusFilter">Status:</label>
                            <select id="statusFilter" class="filter-select">
                                <option value="all">All Statuses</option>
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                                <option value="overdue">Overdue</option>
                                <option value="draft">Unfinished</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="clientFilter">Client:</label>
                            <select id="clientFilter" class="filter-select">
                                <option value="all">All Clients</option>
                            </select>
                        </div>
     
                   <!--  Consolidated Date Range Filter -->
                        <div class="filter-group">
                            <label for="dateRangeFilter">Date Range:</label>
                            <select id="dateRangeFilter" class="filter-select">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <div class="search-filter">
                            <label for="searchInvoices">Search:</label>
                            <input type="text" id="searchInvoices" placeholder="Invoice number, client name...">
                            <button id="clearFilters" class="clear-filters-btn">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>

                        <!-- Export Buttons -->
                        <div class="export-buttons">
                            <button id="exportCsvBtn" class="btn btn-success">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button id="exportSaftBtn" class="btn btn-primary">
                                <i class="fas fa-file-code"></i> Export SAFT
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Invoices Table -->
                <div class="table-responsive">
                    <table id="invoicesTable" class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    Invoice # 
                                    <span class="sort-icon" data-sort="invoice">
                                        <i class="fas fa-sort"></i>
                                    </span>
                                </th>
                                <th>
                                    Client 
                                    <span class="sort-icon" data-sort="client">
                                        <i class="fas fa-sort"></i>
                                    </span>
                                </th>
                                <th>
                                    Date 
                                    <span class="sort-icon" data-sort="date">
                                        <i class="fas fa-sort"></i>
                                    </span>
                                </th>
                                <th>
                                    Due Date 
                                    <span class="sort-icon" data-sort="dueDate">
                                        <i class="fas fa-sort"></i>
                                    </span>
                                </th>
                                <th>
                                    Amount 
                                    <span class="sort-icon" data-sort="amount">
                                        <i class="fas fa-sort"></i>
                                    </span>
                                </th>
                                <th>
                                    Status 
                                    <span class="sort-icon" data-sort="status">
                                        <i class="fas fa-sort"></i>
                                    </span>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center">Loading invoices...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination">
                    <span class="page-info"></span>
                    <div class="page-controls">
                        <button class="pagination-btn" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="pagination-btn active">1</button>
                        <button class="pagination-btn">2</button>
                        <button class="pagination-btn">3</button>
                        <span class="pagination-ellipsis">...</span>
                        <button class="pagination-btn">60</button>
                        <button class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- No Results Message (hidden by default) -->
            <div id="noResultsMessage" class="no-results" style="display: none;">
                <i class="fas fa-search fa-3x"></i>
                <h3>No invoices found</h3>
                <p>Try adjusting your search or filter criteria</p>
                <a href="#" id="resetFiltersLink">Reset all filters</a>
            </div>
        </div>
    </div>
    
    <!-- Create Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Invoice</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <div class="form-grid">

                        <div class="form-section">
                            <h3>Client Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="client-list">Client Name/Company</label>
                                    <div class="client-input-wrapper">
                                        <input type="text" id="client-list" placeholder="Type client name..." autocomplete="off" list="client-options">
                                        <datalist id="client-options"></datalist>
                                        <button type="button" id="add-client-btn" class="btn secondary-btn" style="display:none;">
                                            <i class="fas fa-plus"></i> New Client
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clientEmail">Email</label>
                                    <input type="email" id="clientEmail" placeholder="client@example.com" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="clientTaxId">Tax ID (NUIT)</label>
                                    <input type="text" id="clientTaxId" placeholder="e.g. 123456789" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clientAddress">Address</label>
                                    <textarea id="clientAddress" rows="3" placeholder="Client's full address" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Invoice Details</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="invoiceNumber">Invoice Number</label>
                                    <input type="text" id="invoiceNumber" value="Generating invoice number" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="issueDate">Issue Date</label>
                                    <input type="date" id="issueDate" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dueDate">Due Date</label>
                                    <input type="date" id="dueDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="currency">Currency</label>
                                    <select id="currency" required>
                                        <option value="MZN" selected>MZN - Mozambican Metical</option>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - British Pound</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paymentTerms">Payment Terms</label>
                                    <select id="paymentTerms" required>
                                        <option value="net30" selected>Net 30 - Due in 30 days</option>
                                        <option value="net15">Net 15 - Due in 15 days</option>
                                        <option value="net60">Net 60 - Due in 60 days</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Items</h3>
                        <div class="items-table-container">
                            <table id="itemsTable" class="items-table">
                                <thead>
                                    <tr>
                                        <th width="40%">Description</th>
                                        <th width="15%">Quantity</th>
                                        <th width="15%">Unit Price</th>
                                        <th width="10%">VAT (16%)</th>
                                        <th width="15%">Total</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="item-row">
                                        <td>
                                            <div class="item-description-wrapper">
                                                <input type="text" class="item-description" placeholder="Enter item description">
                                                <div class="product-suggestions" style="display: none;"></div>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="number" class="item-quantity" value="1" min="1" step="1">
                                        </td>
                                        <td>
                                            <input type="number" class="item-price" value="0.00" min="0" step="0.01">
                                        </td>
                                        <td>
                                            <span class="item-vat">0.00</span>
                                        </td>
                                        <td>
                                            <span class="item-total">0.00</span>
                                        </td>
                                        <td>
                                            <button type="button" class="remove-item-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button type="button" id="addItemBtn" class="btn secondary-btn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                        
                        <div class="invoice-totals">
                            <div class="totals-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span>VAT (16%):</span>
                                <span id="totalVat">0.00</span>
                            </div>
                            <div class="totals-row">
                                <span>Total:</span>
                                <span id="invoiceTotal">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Notes & Terms</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="notes">Additional Notes</label>
                                <textarea id="notes" rows="3" placeholder="Add any additional notes or terms..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn secondary-btn" id="previewInvoiceBtn">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button type="submit" class="btn primary-btn">
                            <i class="fas fa-check"></i> Publish Invoice
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Invoice Details</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invoice-view-header">
                    <div class="invoice-view-info">
                        <h3 id="viewInvoiceNumber">INV-2025-0001</h3>
                        <span id="viewInvoiceStatus" class="status paid">Paid</span>
                    </div>
                    <div class="invoice-view-actions">
                        <button class="btn secondary-btn" id="downloadPdfBtn">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                        <button class="btn primary-btn" id="sendInvoiceBtn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
                
                <div class="invoice-preview-container">
                    <div id="invoicePreviewContent">
                        <!-- Invoice content will be inserted here -->
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn primary-btn" id="closeInvoiceBtn">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Email Invoice Modal -->
    <div id="emailInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Invoice</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="emailInvoiceForm">
                    <div class="form-group">
                        <label for="emailTo">To:</label>
                        <input type="email" id="emailTo" required>
                    </div>
                    <div class="form-group">
                        <label for="emailSubject">Subject:</label>
                        <input type="text" id="emailSubject" required>
                    </div>
                    <div class="form-group">
                        <label for="emailMessage">Message:</label>
                        <textarea id="emailMessage" rows="6" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="emailAttachPdf" checked>
                            Attach invoice as PDF
                        </label>
                    </div>
                    <div class="loading-indicator" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Sending email...
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn secondary-btn close-email-modal">
                    Cancel
                </button>
                <button type="submit" form="emailInvoiceForm" class="btn primary-btn">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <!-- Dark Mode Overlay (used when modal is open) -->
    <div class="modal-overlay"></div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="scripts/templateManager.js"></script>
    <script src="js/topbar-menu.js"></script>
    <script src="js/invoicescripts/notifications.js"></script>
    <script src="js/invoicescripts/tableFilters.js"></script>
    <script src="js/invoicescripts/export.js"></script>
    <script src="js/invoicescripts/modalManager.js"></script>
    <script src="js/invoicescripts/invoiceForm.js"></script>
    <script src="js/invoicescripts/invoiceStatus.js"></script>
    <script src="js/invoicescripts/invoicePreview.js"></script>
    <script src="js/invoicescripts/invoiceItems.js"></script>
    <script src="js/invoicescripts/metrics.js"></script>
    <script src="js/invoicescripts/charts.js"></script>
    <script src="js/invoicescripts/eventListeners.js"></script>
    <script src="js/invoicescripts/invoiceTable.js"></script>
    <script src="js/invoicescripts/invoiceActions.js"></script>
    <script src="js/invoicescripts/pdf.js"></script>
    <script src="js/email-handler.js"></script>
    <script src="js/invoice.js"></script>
    <script src="js/displayname.js"></script>
    <script src="js/walaka-assistant.js"></script>
    <script src="js/hints/page-hints.js"></script>
    <script src="js/hints/walaka-hints.js"></script>

    <!-- Initialize Supabase -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm';
        
        // Create single Supabase instance
        const supabase = createClient(
            'https://qvmtozjvjflygbkjecyj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2bXRvemp2amZseWdia2plY3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjc2MjMsImV4cCI6MjA2MTcwMzYyM30.DJMC1eM5_EouM1oc07JaoXsMX_bSLn2AVCozAcdfHmo',
            {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                }
            }
        );

        // Check for existing session
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            console.warn('No active session found. Some features may be limited.');
        }

        window.supabase = supabase;

        // Clients functionality
        let clients = [];

        async function fetchClients() {
            try {
                const { data, error } = await supabase.from('clients').select('*');
                if (error) throw error;
                
                clients = data;
                updateClientDatalist();
                console.log('Clients loaded successfully:', clients.length);
            } catch (error) {
                console.error('Error fetching clients:', error);
                showNotification('Error loading clients: ' + error.message);
            }
        }

        function updateClientDatalist() {
            const datalist = document.getElementById('client-options');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.customer_name;
                option.dataset.clientId = client.id;
                datalist.appendChild(option);
            });
        }

        function setupClientHandlers() {
            const clientInput = document.getElementById('client-list');
            const addClientBtn = document.getElementById('add-client-btn');
            const newClientModal = document.getElementById('newClientModal');
            const saveNewClientBtn = document.getElementById('save-new-client');
            const closeModalBtns = document.querySelectorAll('#newClientModal .close-modal');

            if (clientInput) {
                clientInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    const exists = clients.some(c => c.customer_name === value);
                    if (addClientBtn) {
                        addClientBtn.style.display = (!exists && value) ? 'inline-block' : 'none';
                    }
                });

                clientInput.addEventListener('change', function() {
                    const selectedClient = clients.find(c => c.customer_name === this.value);
                    if (selectedClient) {
                        populateClientFields(selectedClient);
                    }
                });
            }

            if (addClientBtn) {
                addClientBtn.addEventListener('click', function() {
                    if (newClientModal) {
                        const clientNameInput = document.getElementById('new-client-name');
                        if (clientNameInput) {
                            clientNameInput.value = document.getElementById('client-list').value;
                        }
                        openModal('newClientModal');
                    }
                });
            }

            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal('newClientModal');
                });
            });

            if (saveNewClientBtn) {
                saveNewClientBtn.addEventListener('click', async function() {
                    try {
                        const name = document.getElementById('new-client-name').value;
                        const nuit = document.getElementById('new-client-nuit').value;
                        const email = document.getElementById('new-client-email').value;
                        const address = document.getElementById('new-client-address').value;

                        if (!name) {
                            throw new Error('Client name is required');
                        }

                        const { data, error } = await supabase
                            .from('clients')
                            .insert([{ 
                                customer_name: name,
                                nuit: nuit,
                                email: email,
                                address: address
                            }])
                            .select();

                        if (error) throw error;

                        clients.push(data[0]);
                        updateClientDatalist();
                        
                        if (clientInput) clientInput.value = name;
                        populateClientFields(data[0]);
                        closeModal('newClientModal');
                        
                        showNotification('Client added successfully');
                    } catch (error) {
                        console.error('Error adding client:', error);
                        showNotification('Error adding client: ' + error.message);
                    }
                });
            }
        }

        function populateClientFields(client) {
            if (!client) return;
            
            const emailInput = document.getElementById('clientEmail');
            const taxIdInput = document.getElementById('clientTaxId');
            const addressInput = document.getElementById('clientAddress');

            if (emailInput) emailInput.value = client.email || '';
            if (taxIdInput) taxIdInput.value = client.customer_tax_id || '';
            
            // Build full address from components
            const addressParts = [
                client.building_number,
                client.street_name,
                client.address_detail,
                client.city,
                client.province,
                client.postal_code,
                client.country
            ].filter(Boolean);
            
            if (addressInput) addressInput.value = addressParts.join(', ');
        }

        // Products functionality
        let cachedProducts = [];

        async function fetchProducts() {
            try {
                console.log("Fetching products...");
                const { data, error } = await supabase.from('products').select('*');

                if (error) throw error;

                cachedProducts = data;
                console.log("Products loaded:", cachedProducts.length);
            } catch (error) {
                console.error('Error fetching products:', error);
                showNotification('Error loading products: ' + error.message);
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Wait for window.supabase to be initialized by the module script
                while (!window.supabase || !window.supabase.auth) {
                    console.log('Waiting for Supabase client initialization...');
                    await new Promise(resolve => setTimeout(resolve, 100)); // Wait 100ms
                }
                console.log('Supabase client initialized!', window.supabase);

                // Initialize invoice actions - Pass the initialized supabase client
                if (window.InvoiceActions && window.supabase) {
                    window.invoiceActions = new window.InvoiceActions(window.supabase);
                    console.log('Invoice actions initialized successfully');
                } else {
                    console.error('InvoiceActions class or Supabase client not found during actions initialization');
                }

                // Initialize table filters first
                if (typeof window.setupTableFilters === 'function') {
                    window.setupTableFilters();
                    console.log('Table filters initialized successfully');
                } else {
                    console.error('Table filters setup function not found');
                }

                // Initialize invoice table
                if (typeof window.fetchAndDisplayInvoices === 'function') {
                    await window.fetchAndDisplayInvoices(1, 10, {});
                    console.log('Invoice table initialized successfully');
                } else {
                    console.error('Invoice table functions not found');
                }

                // Initialize invoice items
                if (window.InvoiceItems) {
                    window.invoiceItems = new window.InvoiceItems();
                    console.log('Invoice items initialized successfully');
                } else {
                    console.error('InvoiceItems class not found');
                }

                // Initialize charts
                if (typeof window.setupCharts === 'function') {
                    window.setupCharts();
                    window.setupChartPeriodControls();
                    console.log('Charts initialized successfully');
                } else {
                    console.error('Chart setup functions not found');
                }

                // Initialize metrics
                if (typeof window.updateMetricsDisplay === 'function') {
                    await window.updateMetricsDisplay();
                    window.setupMetricsSubscription();
                    console.log('Metrics initialized successfully');
                } else {
                    console.error('Metrics functions not found');
                }

                // Update charts with data
                if (typeof window.updateCharts === 'function') {
                    await window.updateCharts();
                    window.setupChartSubscription();
                    console.log('Charts updated successfully');
                } else {
                    console.error('Chart update functions not found');
                }

                // Setup client handlers
                setupClientHandlers();

                // Fetch initial data
                await fetchClients();
                await fetchProducts();

            } catch (error) {
                console.error('Error during initialization:', error);
                showNotification('Error initializing application: ' + error.message);
            }
        });
    </script>
<!--
     Date Range Modal 
    <div id="dateRangeModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Date Range</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="applyDateRange">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <style>
    #dateRangeModal .modal-body {
        padding: 20px;
    }

    #dateRangeModal .form-group {
        margin-bottom: 15px;
    }

    #dateRangeModal label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    #dateRangeModal input[type="date"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    </style>
-->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date range modal
        const dateRangeFilter = document.getElementById('dateRangeFilter');
        const dateRangeModal = $('#dateRangeModal');
        
        if (dateRangeFilter && dateRangeModal.length) {
            dateRangeFilter.addEventListener('change', function() {
                if (this.value === 'custom') {
                    dateRangeModal.modal('show');
                } else {
                    // Apply preset filter when a non-custom option is selected
                     if (window.invoiceTable && typeof window.invoiceTable.applyFilters === 'function') {
                        window.invoiceTable.currentFilters.dateRange = this.value;
                        window.invoiceTable.currentFilters.customDateRange = null;
                        window.invoiceTable.applyFilters();
                    } else {
                        console.error('invoiceTable or applyFilters not found');
                    }
                }
            });
        }

        // Set default dates in modal
        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        if (startDateInput) startDateInput.value = lastMonth.toISOString().split('T')[0];
        if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];

        // Handle date range application
        const applyDateRangeBtn = document.getElementById('applyDateRange');
        if (applyDateRangeBtn && startDateInput && endDateInput) {
            applyDateRangeBtn.addEventListener('click', function() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (!startDate || !endDate) {
                    showNotification('Please select both start and end dates', 'error');
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    showNotification('Start date cannot be after end date', 'error');
                    return;
                }

                // Update the table with the custom date range
                if (window.invoiceTable && typeof window.invoiceTable.applyFilters === 'function') {
                     if (dateRangeFilter) dateRangeFilter.value = 'custom';
                    window.invoiceTable.currentFilters.dateRange = 'custom';
                    window.invoiceTable.currentFilters.customDateRange = {
                        startDate: startDate,
                        endDate: endDate
                    };
                    window.invoiceTable.applyFilters();
                } else {
                    console.error('invoiceTable or applyFilters not found');
                }
                dateRangeModal.modal('hide');
            });
        }

        // Handle export button clicks
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportSaftBtn = document.getElementById('exportSaftBtn');
        const exportPeriodFilter = document.getElementById('dateRangeFilter'); 

        if (exportCsvBtn && typeof window.exportInvoicesAsCsv === 'function' && exportPeriodFilter) {
            exportCsvBtn.addEventListener('click', function() {
                const period = exportPeriodFilter.value;
                if (period === 'custom') {
                    const startDate = startDateInput ? startDateInput.value : null;
                    const endDate = endDateInput ? endDateInput.value : null;
                    if (!startDate || !endDate) {
                         showNotification('Please select custom dates for export first', 'error');
                         return;
                    }
                    window.exportInvoicesAsCsv({ period: 'custom', startDate: startDate, endDate: endDate });
                } else {
                    window.exportInvoicesAsCsv(period);
                }
            });
        }

        if (exportSaftBtn && typeof window.exportInvoicesAsSaft === 'function' && exportPeriodFilter) {
            exportSaftBtn.addEventListener('click', function() {
                const period = exportPeriodFilter.value;
                 if (period === 'custom') {
                    const startDate = startDateInput ? startDateInput.value : null;
                    const endDate = endDateInput ? endDateInput.value : null;
                    if (!startDate || !endDate) {
                         showNotification('Please select custom dates for export first', 'error');
                         return;
                    }
                    window.exportInvoicesAsSaft({ period: 'custom', startDate: startDate, endDate: endDate });
                } else {
                    window.exportInvoicesAsSaft(period);
                }
            });
        }
    });
    </script>
</body>
</html>