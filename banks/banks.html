<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WALAKA - Banks & Mobile Wallets</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    
    <!-- Internal CSS -->
    <link rel="stylesheet" href="../components/sidebar.css">
    <link rel="stylesheet" href="assets/css/banks.css">
    <link rel="stylesheet" href="../components/trial-restrictions.css">


    <!-- Initialize Supabase -->
    <script type="module">
/*        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        const supabaseUrl = 'https://qvmtozjvjflygbkjecyj.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2bXRvemp2amZseWdia2plY3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjc2MjMsImV4cCI6MjA2MTcwMzYyM30.DJMC1eM5_EouM1oc07JaoXsMX_bSLn2AVCozAcdfHmo';
        window.supabase = createClient(supabaseUrl, supabaseKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                storage: window.localStorage,
                storageKey: 'supabase-auth-token'
            }
        });*/
    </script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Menu -->
        <div id="sidebar-container"></div>
        <script>
        // Dynamically load the sidebar from components/sidebar.html
        document.addEventListener('DOMContentLoaded', function() {
            fetch('../components/sidebar.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                    // Dynamically load the sidebar-actions.js script after sidebar is injected
                    var script = document.createElement('script');
                    script.src = '../components/sidebar-actions.js';
                    document.body.appendChild(script);
                })
                .catch(err => {
                    console.error('Failed to load sidebar:', err);
                });
        });
        </script>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="search-bar">
                    <input type="text" placeholder="Pesquisar..." data-translate-placeholder="search_placeholder">
                </div>
                <div class="user-menu">
                    <div class="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="badge">0</span>
                    </div>
                    <div class="user-profile">
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span id="user-name">Loading...</span>
                        <div class="dropdown">
                            <button class="dropdown-toggle"><i class="fas fa-caret-down"></i></button>
                            <div class="dropdown-menu">
                                <a href="profile.html">Profile Management</a>
                                <a href="settings.html">General Settings</a>
                                <a href="#" id="sign-out-btn">Sign Out</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add trial banner and restrictions system -->
            <div id="trial-banner-container"></div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                fetch('../components/trial-banner.html')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(html => {
                        document.getElementById('trial-banner-container').innerHTML = html;
                        
                        // Load the banner script
                        const bannerScript = document.createElement('script');
                        bannerScript.type = 'module';
                        bannerScript.src = '../components/trial-banner.js';
                        document.body.appendChild(bannerScript);
                        
                        // Load the restrictions script immediately after
                        const restrictionsScript = document.createElement('script');
                        restrictionsScript.src = '../components/trial-restrictions.js';
                        document.body.appendChild(restrictionsScript);
                    })
                    .catch(error => {
                        console.error('Failed to load trial banner component:', error);
                    });
            });
            </script>

            <!-- Banks Page Header -->
            <div class="page-header">
                <div>
                    <h1>Banks & Mobile Wallets</h1>
                    <p>Manage your payment accounts for receiving client payments</p>
                </div>
                <button id="add-account-btn" class="primary-btn">
                    <i class="fas fa-plus"></i> Add New Account
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="banks-container">
                <!-- Banks Summary Cards -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon bank-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="bank-count">0</div>
                            <div class="metric-label">Bank Accounts</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon wallet-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="wallet-count">0</div>
                            <div class="metric-label">Mobile Wallets</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon currency-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="currency-count">0</div>
                            <div class="metric-label">Currencies</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon primary-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <div class="metric-value" id="primary-account">None</div>
                            <div class="metric-label">Primary Account</div>
                        </div>
                    </div>
                </div>

                <!-- Filter & Controls -->
                <div class="controls-container">
                    <div class="filters">
                        <div class="filter-group">
                            <label for="filter-type">Account Type:</label>
                            <select id="filter-type">
                                <option value="all">All Types</option>
                                <option value="bank">Bank Accounts</option>
                                <option value="wallet">Mobile Wallets</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-currency">Currency:</label>
                            <select id="filter-currency">
                                <option value="all">All Currencies</option>
                                <option value="MZN">MZN</option>
                                <option value="USD">USD</option>
                                <option value="ZAR">ZAR</option>
                            </select>
                        </div>
                    </div>
                    <div class="view-options">
                        <button class="view-option-btn active" data-view="table">
                            <i class="fas fa-table"></i>
                        </button>
                        <button class="view-option-btn" data-view="cards">
                            <i class="fas fa-th-large"></i>
                        </button>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <h3>No Bank Accounts or Wallets Found</h3>
                    <p>Add your first bank account or mobile wallet to start receiving payments from clients.</p>
                    <button class="primary-btn" id="empty-add-btn">
                        <i class="fas fa-plus"></i> Add New Account
                    </button>
                </div>

                <!-- Table View -->
                <div id="table-view" class="table-view">
                    <div class="table-container">
                        <table class="accounts-table">
                            <thead>
                                <tr>
                                    <th class="type-col">Type</th>
                                    <th class="name-col">Name</th>
                                    <th class="holder-col">Account Holder</th>
                                    <th class="number-col">Account Number</th>
                                    <th class="currency-col">Currency</th>
                                    <th class="action-col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-table-body">
                                <!-- Table rows will be inserted here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cards View -->
                <div id="cards-view" class="cards-view">
                    <div id="accounts-cards-container" class="accounts-cards">
                        <!-- Account cards will be inserted here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Modals -->
            <!-- Add/Edit Account Modal -->
            <div id="account-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title">Add New Account</h2>
                        <button class="close-modal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="account-form">
                            <input type="hidden" id="account-id">
                            <div class="form-group">
                                <label for="account-type">Account Type <span class="required">*</span></label>
                                <select id="account-type" required>
                                    <option value="bank">Bank Account</option>
                                    <option value="wallet">Mobile Wallet</option>
                                </select>
                            </div>

                            <!-- Bank Fields - Only visible when type is 'bank' -->
                            <div id="bank-fields">
                                <div class="form-group">
                                    <label for="bank-name">Bank Name <span class="required">*</span></label>
                                    <select id="bank-name" required>
                                        <option value="">Select Bank</option>
                                        <option value="Millennium BIM">Millennium BIM</option>
                                        <option value="BCI">BCI</option>
                                        <option value="Moza Banco">Moza Banco</option>
                                        <option value="Standard Bank">Standard Bank</option>
                                        <option value="Absa">Absa</option>
                                        <option value="First Capital Bank">First Capital Bank</option>
                                        <option value="Ecobank">Ecobank</option>
                                        <option value="Letshego">Letshego</option>
                                        <option value="United Bank for Africa">United Bank for Africa</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <input type="text" id="bank-name-other" placeholder="Enter Bank Name" style="display: none;">
                                </div>
                            </div>

                            <!-- Wallet Fields - Only visible when type is 'wallet' -->
                            <div id="wallet-fields" style="display: none;">
                                <div class="form-group">
                                    <label for="operator-name">Operator Name <span class="required">*</span></label>
                                    <select id="operator-name" required>
                                        <option value="">Select Operator</option>
                                        <option value="M-PESA">M-PESA</option>
                                        <option value="EMOLA">EMOLA</option>
                                        <option value="mKesh">mKesh</option>
                                        <option value="e-Mola">e-Mola</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <input type="text" id="operator-name-other" placeholder="Enter Operator Name" style="display: none;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="account-holder">Account Holder Name <span class="required">*</span></label>
                                <input type="text" id="account-holder" placeholder="Your full name or business name" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="account-number" id="account-number-label">Account Number <span class="required">*</span></label>
                                    <input type="text" id="account-number" placeholder="Enter account number" required>
                                    <small id="account-number-hint" class="form-hint">Enter your bank account number</small>
                                </div>

                                <div class="form-group">
                                    <label for="currency">Currency <span class="required">*</span></label>
                                    <select id="currency" required>
                                        <option value="MZN">MZN</option>
                                        <option value="USD">USD</option>
                                        <option value="ZAR">ZAR</option>
                                        <option value="EUR">EUR</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Additional Bank Fields -->
                            <div class="bank-additional-fields">
                                <div class="form-group">
                                    <label for="branch">Branch (Optional)</label>
                                    <input type="text" id="branch" placeholder="Enter bank branch">
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="swift-code">SWIFT Code (Optional)</label>
                                        <input type="text" id="swift-code" placeholder="Enter SWIFT/BIC code">
                                    </div>

                                    <div class="form-group">
                                        <label for="is-primary">Make Primary Account</label>
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="is-primary">
                                            <label for="is-primary"></label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="bank-address">Bank Address (Optional)</label>
                                    <textarea id="bank-address" rows="2" placeholder="Enter bank address"></textarea>
                                </div>
                            </div>

                            <!-- Wallet Additional Instructions -->
                            <div class="wallet-instructions" style="display: none;">
                                <div class="form-group">
                                    <label for="wallet-instructions">Payment Instructions</label>
                                    <textarea id="wallet-instructions" rows="2" placeholder="Additional instructions for clients (displayed on invoices)"></textarea>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="secondary-btn" id="cancel-account">Cancel</button>
                                <button type="submit" class="primary-btn" id="save-account">Save Account</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div id="delete-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Delete Account</h2>
                        <button class="close-modal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this account?</p>
                        <p class="warning-text">This action cannot be undone.</p>
                        <div class="delete-account-details">
                            <p><strong>Account Type:</strong> <span id="delete-account-type"></span></p>
                            <p><strong>Account Name:</strong> <span id="delete-account-name"></span></p>
                            <p><strong>Account Number:</strong> <span id="delete-account-number"></span></p>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="secondary-btn" id="cancel-delete">Cancel</button>
                            <button type="button" class="danger-btn" id="confirm-delete">Delete Account</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toast Notification -->
            <div id="toast" class="toast">
                <div class="toast-icon">
                    <i id="toast-icon" class="fas fa-check-circle"></i>
                </div>
                <div class="toast-content">
                    <span id="toast-message">Account saved successfully</span>
                </div>
                <button id="toast-close" class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script type="module">


        // Initialize auth and check session
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user is authenticated
/*            const isAuthenticated = await auth.checkAuth();
            if (!isAuthenticated) {
                window.location.href = '/login.html';
                return;
            }
*/
            // Get user info
            const { data: { user }, error } = await supabase.auth.getUser();
            if (user) {
                const userSpan = document.getElementById('user-name');
                if (userSpan) userSpan.textContent = user.email;
            }

            // Set up auth state change listener
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT' || !session) {
                    window.location.href = '/login.html';
                }
            });
        });

        // Handle sign out
        document.getElementById('sign-out-btn')?.addEventListener('click', async (e) => {
            e.preventDefault();
            await auth.logout();
        });
    </script>
    <script type="module" src="assets/js/banks.js"></script>
    <div id="debug-session" style="background:#fee;color:#900;padding:8px;font-size:14px;display:none;"></div>
</body>
</html>
